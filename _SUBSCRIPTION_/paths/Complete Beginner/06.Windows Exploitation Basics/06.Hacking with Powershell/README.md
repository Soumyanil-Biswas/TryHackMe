
Task2: What is Powershell
--------------------------

Powershell is the _Windows Scripting Language_ and shell environment that is built **using the .NET framework**.

This also allows Powershell to **execute .NET functions directly from its shell**. Most Powershell commands, called cmdlets, are written in .NET. Unlike other scripting languages and shell environments, the _output of these cmdlets are objects_ - making Powershell somewhat **`object oriented`**.
> This also means that running cmdlets allows you to perform actions on the output object(which makes it convenient to pass output from one cmdlet to another).

The normal format of a cmdlet is represented using **`Verb-Noun`**

For Eg:
```
Get-Command
```

Common verbs to use include:

- Get
- Start
- Stop 
- Read
- Write
- New
- Out


To get the full list of approved verbs, visit this [link](https://docs.microsoft.com/en-us/powershell/scripting/developer/cmdlet/approved-verbs-for-windows-powershell-commands?view=powershell-7).


1. What is the command to get help about a particular cmdlet(without any parameters)?

--> Get-Help


Task3: Basic Powershell Commands
---------------------------------

Now that we've understood how cmdlets works - let's explore how to use them!
The main thing to remember here is that `Get-Command` and `Get-Help` are the _best friend_.

<ins>Using Get-Help</ins>

Get-Help displays information about a cmdlet. To get help about a particular command, run the following:

`Get-Help Command-Name`

You can also understand how exactly to use the command by passing in the _-examples_ flag.
```
PS C:\Windows\System32> Get-Help Get-Command -Examples

NAME
    Get-Command

SYNOPSIS
    Gets all commands.


    -------- Example 1: Get cmdlets, functions, and aliases --------

    Get-Command


    -------- Example 2: Get commands in the current session --------

    Get-Command -ListImported


    ------- Example 3: Get cmdlets and display them in order -------

    Get-Command -Type Cmdlet | Sort-Object -Property Noun | Format-Table -GroupBy Noun


    ------------- Example 4: Get commands in a module -------------

---SNIP---
```

<ins>Using Get-Command</ins>

Get-Command gets all the cmdlets installed on the current Computer.

The great thing about this cmdlet is that it allows for pattern matching like the following:

1. `Get-Command Verb-*`
OR
2. `Get-Command *-Noun`

Running `Get-Command New-*` to view all the _cmdlets_ for the verb new displays the following:
```
PS C:\Windows\System32> Get-Command New-*

CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Function        New-AutologgerConfig                               1.0.0.0    EventTracingManagement
Function        New-DAEntryPointTableItem                          1.0.0.0    DirectAccessClientComponents
Function        New-DscChecksum                                    1.1        PSDesiredStateConfiguration
Function        New-EapConfiguration                               2.0.0.0    VpnClient
Function        New-EtwTraceSession                                1.0.0.0    EventTracingManagement
Function        New-FileShare                                      2.0.0.0    Storage
Function        New-Fixture                                        3.4.0      Pester
Function        New-Guid                                           3.1.0.0    Microsoft.PowerShell.Utility
Function        New-IscsiTargetPortal                              1.0.0.0    iSCSI
Function        New-IseSnippet                                     1.0.0.0    ISE
Function        New-MaskingSet                                     2.0.0.0    Storage
Function        New-NetAdapterAdvancedProperty                     2.0.0.0    NetAdapter
Function        New-NetEventSession                                1.0.0.0    NetEventPacketCapture
Function        New-NetFirewallRule                                2.0.0.0    NetSecurity
Function        New-NetIPAddress                                   1.0.0.0    NetTCPIP
Function        New-NetIPHttpsConfiguration                        1.0.0.0    NetworkTransition
Function        New-NetIPsecDospSetting                            2.0.0.0    NetSecurity
Function        New-NetIPsecMainModeCryptoSet                      2.0.0.0    NetSecurity
Function        New-NetIPsecMainModeRule                           2.0.0.0    NetSecurity
Function        New-NetIPsecPhase1AuthSet                          2.0.0.0    NetSecurity
Function        New-NetIPsecPhase2AuthSet                          2.0.0.0    NetSecurity
Function        New-NetIPsecQuickModeCryptoSet                     2.0.0.0    NetSecurity
Function        New-NetIPsecRule                                   2.0.0.0    NetSecurity
Function        New-NetLbfoTeam                                    2.0.0.0    NetLbfo
Function        New-NetNat                                         1.0.0.0    NetNat
Function        New-NetNatTransitionConfiguration                  1.0.0.0    NetworkTransition
Function        New-NetNeighbor                                    1.0.0.0    NetTCPIP
Function        New-NetQosPolicy                                   2.0.0.0    NetQos
Function        New-NetRoute                                       1.0.0.0    NetTCPIP
Function        New-NetSwitchTeam                                  1.0.0.0    NetSwitchTeam
Function        New-NetTransportFilter                             1.0.0.0    NetTCPIP
Function        New-NetworkSwitchVlan                              1.0.0.0    NetworkSwitchManager
Function        New-Partition                                      2.0.0.0    Storage
Function        New-PesterOption                                   3.4.0      Pester
Function        New-PSWorkflowSession                              2.0.0.0    PSWorkflow
Function        New-ScheduledTask                                  1.0.0.0    ScheduledTasks
Function        New-ScheduledTaskAction                            1.0.0.0    ScheduledTasks
Function        New-ScheduledTaskPrincipal                         1.0.0.0    ScheduledTasks
Function        New-ScheduledTaskSettingsSet                       1.0.0.0    ScheduledTasks
Function        New-ScheduledTaskTrigger                           1.0.0.0    ScheduledTasks
Function        New-ScriptFileInfo                                 1.0.0.1    PowerShellGet
Function        New-SmbGlobalMapping                               2.0.0.0    SmbShare
Function        New-SmbMapping                                     2.0.0.0    SmbShare
Function        New-SmbMultichannelConstraint                      2.0.0.0    SmbShare
Function        New-SmbServerCertificateMapping                    2.0.0.0    SmbShare
Function        New-SmbShare                                       2.0.0.0    SmbShare
Function        New-StorageBusBinding                              1.0.0.0    StorageBusCache
Function        New-StorageBusCacheStore                           1.0.0.0    StorageBusCache

				x---SNIP---X

```

<ins>Object Manipulation</ins>

In the previous task, we saw how the output of every cmdlet is an object. If we want to actually manipulate the output, we need to figure out a few things:

	- passing output to other cmdlets
	- using specific object cmdlets to extract information


The Pipeline(|) is used to pass output from one cmdlet to another.

#### NOTE:
> A major difference compared to other shells is that instead of passing text or string to the command after the pipe, powershell **`passes an object to the next cmdlet`**.

Like every object in object oriented frameworks, an object will contain methods and properties.

You can think of ***methods as functions*** that can be applied to _output from the cmdlet_ and you can think of ***properties as variables*** in the _output from a cmdlet_.

```
Verb-Noun | Get-Member
```

For Eg:
```
Get-Command | Get-Member -MemberType Method
```

```
PS C:\Windows\System32> Get-Command | Get-Member -MemberType Method


   TypeName: System.Management.Automation.AliasInfo

Name             MemberType Definition
----             ---------- ----------
Equals           Method     bool Equals(System.Object obj)
GetHashCode      Method     int GetHashCode()
GetType          Method     type GetType()
ResolveParameter Method     System.Management.Automation.ParameterMetadata ResolveParameter(string name)
ToString         Method     string ToString()


   TypeName: System.Management.Automation.FunctionInfo

Name             MemberType Definition
----             ---------- ----------
Equals           Method     bool Equals(System.Object obj)
GetHashCode      Method     int GetHashCode()
GetType          Method     type GetType()
ResolveParameter Method     System.Management.Automation.ParameterMetadata ResolveParameter(string name)
ToString         Method     string ToString()


   TypeName: System.Management.Automation.CmdletInfo

Name             MemberType Definition
----             ---------- ----------
Equals           Method     bool Equals(System.Object obj)
GetHashCode      Method     int GetHashCode()
GetType          Method     type GetType()
ResolveParameter Method     System.Management.Automation.ParameterMetadata ResolveParameter(string name)
ToString         Method     string ToString()
```

From the above flag in the command, you can see that you can also select between methods and properties.


Creating Objects From Previous cmdlets
---------------------------------------

One way of manipulating objects is pulling out the properties from the output of a cmdlet and creating a new object. This is done using the `Select-Object` cmdlet.

```
PS C:\Users> Get-ChildItem | Select-Object -Property Mode, Name
OR,
PS C:\Users> Get-ChildItem | Select-Object Mode, Name

Mode   Name
----   ----
d----- Administrator
d-r--- Public
d----- reveng007
d----- Testing
```

You can also use the following flags to select particular information:

	- first - gets the first x object
	- last - gets the last x object
	- unique - shows the unique objects
	- skip - skips x objects



<ins>Filtering Objects</ins>

When retrieving output objects, you may want to select objects that match a very specific value. You can do this using the `Where-Object` to filter based on the value of properties. 


The general format of the using this _cmdlet_ is 
`Verb-Noun | Where-Object -Property PropertyName -operator Value`
and
`Verb-Noun | Where-Object {$_.PropertyName -operator Value}`

The second version uses the $_ operator to iterate through every object passed to the Where-Object cmdlet.

**Powershell is quite sensitive so make sure you don't put quotes around the command!**

Where `-operator` is a list of the following operators:

	- -Contains: if any item in the property value is an exact match for the specified value
	- -EQ: if the property value is the same as the specified value
	- -GT: if the property value is greater than the specified value


For a full list of operators, use this [link](For a full list of operators, use this link).

```
PS C:\Users> Get-Service | Where-Object -Property Status -eq stopped

Status   Name               DisplayName
------   ----               -----------
Stopped  AarSvc_3d7d7       Agent Activation Runtime_3d7d7
Stopped  AJRouter           AllJoyn Router Service
Stopped  ALG                Application Layer Gateway Service
Stopped  AppIDSvc           Application Identity
Stopped  AppMgmt            Application Management
Stopped  AppReadiness       App Readiness
Stopped  AppVClient         Microsoft App-V Client
Stopped  AssignedAccessM... AssignedAccessManager Service
Stopped  autotimesvc        Cellular Time
Stopped  AxInstSV           ActiveX Installer (AxInstSV)
Stopped  BcastDVRUserSer... GameDVR and Broadcast User Service_...
Stopped  BDESVC             BitLocker Drive Encryption Service
Stopped  BITS               Background Intelligent Transfer Ser...
Stopped  BluetoothUserSe... Bluetooth User Support Service_3d7d7
Stopped  brave              Brave Update Service (brave)
Stopped  bravem             Brave Update Service (bravem)
Stopped  BTAGService        Bluetooth Audio Gateway Service
Stopped  BthAvctpSvc        AVCTP service
Stopped  bthserv            Bluetooth Support Service
Stopped  camsvc             Capability Access Manager Service
Stopped  CaptureService_... CaptureService_3d7d7
Stopped  CertPropSvc        Certificate Propagation
Stopped  ClipSVC            Client License Service (ClipSVC)
Stopped  COMSysApp          COM+ System Application
Stopped  ConsentUxUserSv... ConsentUX_3d7d7
Stopped  CredentialEnrol... CredentialEnrollmentManagerUserSvc_...
Stopped  CscService         Offline Files
Stopped  defragsvc          Optimize drives

		X---SNIP---X
```

<ins>Sort Object</ins>

When a cmdlet outputs a lot of information, you may need to sort it to extract the information more efficiently. You do this by pipe lining the output of a cmdlet to the `Sort-Object` cmdlet.

```
Verb-Noun | Sort-Object
```

```
PS C:\Users> Get-ChildItem | Sort-Object


    Directory: C:\Users


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----          7/5/2021   5:24 AM                Administrator
d-r---        11/19/2020   1:18 PM                Public
d-----          7/7/2021   8:26 PM                reveng007
d-----          7/5/2021   4:40 AM                Testing
```

1. What is the location of the file "interesting-file.txt"

```
PS C:\Users> Get-ChildItem -Path C:\ -Include *interesting-file.txt* -File -Recurse -ErrorAction SilentlyContinue


    Directory: C:\Program Files


Mode                LastWriteTime         Length Name

----                -------------         ------ ----

-a----        10/3/2019  11:38 PM             23 interesting-file.txt.txt
```

--> C:\Program Files


2. Specify the contents of this file

--> notsointerestingcontent

3. How many cmdlets are installed on the system(only cmdlets, not functions and aliases)?

```
PS C:\Users> Get-Command | Where-Object -Property CommandType -eq Cmdlet | measure
```
```
PS C:\Users> Get-Command | Where-Object CommandType -eq Cmdlet | measure


Count    : 6638
Average  :
Sum      :
Maximum  :
Minimum  :
Property :
```

--> 6638


4. Get the MD5 hash of interesting-file.txt

```
PS C:\Users> Get-FileHash 'C:\Program Files\interesting-file.txt.txt' -Algorithm md5


Algorithm       Hash                                                                   Path
---------       ----                                                                   ----

MD5             49A586A2A9456226F8A1B4CEC6FAB329                                       C:\Program Files\interesting-file.txt.txt
```

--> 49A586A2A9456226F8A1B4CEC6FAB329


5. What is the command to get the current working directory?

--> Get-Location

6. Does the path "C:\Users\Administrator\Documents\Passwords" Exist(Y/N)?

--> N

7. What command would you use to make a request to a web server?

--> Invoke-Webrequest

alias of `Invoke-Webrequest` => `wget`

8. Base64 decode the file b64.txt on Windows.

```
PS C:\Users\Administrator\Desktop> certutil -decode "C:\Users\Administrator\Desktop\b64.txt" decode.txt

Input Length = 432
Output Length = 323
CertUtil: -decode command completed successfully.


PS C:\Users\Administrator\Desktop> ls


    Directory: C:\Users\Administrator\Desktop


Mode                LastWriteTime         Length Name

----                -------------         ------ ----

d-----        10/5/2019   1:14 PM                emails
-a----        10/3/2019  11:56 PM            432 b64.txt
-a----         7/7/2021   8:57 PM            323 decode.txt
-a----        10/5/2019  12:48 PM            231 listening-ports.ps1
-a----        10/5/2019  12:17 PM             48 ports.txt


PS C:\Users\Administrator\Desktop> cat .\decode.txt

this is the flag - ihopeyoudidthisonwindows
```
--> ihopeyoudidthisonwindows


Task4: Enumeration
--------------------

The first step when you have gained initial access to any machine would be to enumerate. We'll be enumerating the following:

- users
- basic networking information
- file permissions
- registry permissions
- scheduled and running tasks
- insecure files

Your task will be to answer the following questions to enumerate the machine using Powershell commands!


1. How many users are there on the machine?

```
PS C:\Users\Administrator\Desktop> Get-LocalUser


Name           Enabled Description

----           ------- -----------

Administrator  True    Built-in account for administering the computer/domain

DefaultAccount False   A user account managed by the system.

duck           True

duck2          True

Guest          False   Built-in account for guest access to the computer/domain
```

```
PS C:\Users\Administrator\Desktop> net user

User accounts for \\EC2AMAZ-5M13VM2

-------------------------------------------------------------------------------

Administrator            DefaultAccount           duck

duck2                    Guest

The command completed successfully.
```

--> 5

2. Which local user does this SID(S-1-5-21-1394777289-3961777894-1791813945-501) belong to?

For cmd and powershell:
```
> WMIC useraccount get name,sid

Name            SID
Administrator   S-1-5-21-1394777289-3961777894-1791813945-500
DefaultAccount  S-1-5-21-1394777289-3961777894-1791813945-503
duck            S-1-5-21-1394777289-3961777894-1791813945-1008
duck2           S-1-5-21-1394777289-3961777894-1791813945-1009
Guest           S-1-5-21-1394777289-3961777894-1791813945-501
```

For only powershell:

Check with this:
```
(Get-Command Get-LocalUser).Parameters
```

Now apply:
```
Get-LocalUser -SID "S-1-5-21-1394777289-3961777894-1791813945-501"

Name  Enabled Description
----  ------- -----------
Guest False   Built-in account for guest access to the computer/domain
```

--> Guest

3. How many users have their password required values set to False?

```
PS C:\Users\Administrator\Desktop> Get-LocalUser | Format-List

		X---Snip---X

PasswordRequired       : True
Name                   : Administrator

		X---Snip---X
```

```
PS C:\Users\Administrator\Desktop> Get-LocalUser | Where-Object -Property PasswordRequired -match False

Name           Enabled Description
----           ------- -----------
DefaultAccount False   A user account managed by the system.
duck           True
duck2          True
Guest          False   Built-in account for guest access to the computer/domain
```

--> 4

see: **Difference** b/w _-eq_ and _-match_ in powershell??


4. How many local groups exist?

```
PS C:\Users\Administrator\Desktop> Get-LocalGroup | measure

Count    : 24
Average  :
Sum      :
Maximum  :
Minimum  :
Property :
```

--> 24


5. What command did you use to get the IP address info?

For cmd as well as powershell:
```
PS C:\Users\Administrator\Desktop> ipconfig

Windows IP Configuration


Ethernet adapter Ethernet:

   Connection-specific DNS Suffix  . : eu-west-1.compute.internal
   Link-local IPv6 Address . . . . . : fe80::e08a:f357:4be4:866a%5
   IPv4 Address. . . . . . . . . . . : 10.10.168.71
   Subnet Mask . . . . . . . . . . . : 255.255.0.0
   Default Gateway . . . . . . . . . : 10.10.0.1

Tunnel adapter Reusable ISATAP Interface {90ABCE23-305A-4BDE-AA39-4FFDA7413134}:


   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : eu-west-1.compute.internal

Tunnel adapter Local Area Connection* 3:

   Connection-specific DNS Suffix  . :
   IPv6 Address. . . . . . . . . . . : 2001:0:2851:782c:3449:2249:f5f5:57b8
   Link-local IPv6 Address . . . . . : fe80::3449:2249:f5f5:57b8%7
   Default Gateway . . . . . . . . . : ::
```

Only for powershell:
```
PS C:\Users\Administrator\Desktop> Get-NetIPAddress

IPAddress         : fe80::3449:2249:f5f5:57b8%7
InterfaceIndex    : 7
InterfaceAlias    : Local Area Connection* 3
AddressFamily     : IPv6
Type              : Unicast
PrefixLength      : 64
PrefixOrigin      : WellKnown
SuffixOrigin      : Link
AddressState      : Preferred
ValidLifetime     : Infinite ([TimeSpan]::MaxValue)
PreferredLifetime : Infinite ([TimeSpan]::MaxValue)
SkipAsSource      : False
PolicyStore       : ActiveStore

IPAddress         : 2001:0:2851:782c:3449:2249:f5f5:57b8
InterfaceIndex    : 7
InterfaceAlias    : Local Area Connection* 3
AddressFamily     : IPv6
Type              : Unicast
PrefixLength      : 64
PrefixOrigin      : RouterAdvertisement
SuffixOrigin      : Link
AddressState      : Preferred
ValidLifetime     : Infinite ([TimeSpan]::MaxValue)
PreferredLifetime : Infinite ([TimeSpan]::MaxValue)
SkipAsSource      : False
PolicyStore       : ActiveStore

IPAddress         : fe80::e08a:f357:4be4:866a%5
InterfaceIndex    : 5
InterfaceAlias    : Ethernet
AddressFamily     : IPv6
Type              : Unicast
PrefixLength      : 64
PrefixOrigin      : WellKnown
SuffixOrigin      : Link
AddressState      : Preferred
ValidLifetime     : Infinite ([TimeSpan]::MaxValue)
PreferredLifetime : Infinite ([TimeSpan]::MaxValue)
SkipAsSource      : False
PolicyStore       : ActiveStore

IPAddress         : fe80::5efe:10.10.168.71%6
InterfaceIndex    : 6
InterfaceAlias    : Reusable ISATAP Interface {90ABCE23-305A-4BDE-AA39-4FFDA7413134}
AddressFamily     : IPv6
Type              : Unicast
PrefixLength      : 128
PrefixOrigin      : WellKnown
SuffixOrigin      : Link
AddressState      : Deprecated
ValidLifetime     : Infinite ([TimeSpan]::MaxValue)
PreferredLifetime : Infinite ([TimeSpan]::MaxValue)
SkipAsSource      : False
PolicyStore       : ActiveStore

IPAddress         : ::1
InterfaceIndex    : 1
InterfaceAlias    : Loopback Pseudo-Interface 1
AddressFamily     : IPv6
Type              : Unicast
PrefixLength      : 128
PrefixOrigin      : WellKnown
SuffixOrigin      : WellKnown
AddressState      : Preferred
ValidLifetime     : Infinite ([TimeSpan]::MaxValue)
PreferredLifetime : Infinite ([TimeSpan]::MaxValue)
SkipAsSource      : False
PolicyStore       : ActiveStore

IPAddress         : 10.10.168.71
InterfaceIndex    : 5
InterfaceAlias    : Ethernet
AddressFamily     : IPv4
Type              : Unicast
PrefixLength      : 16
PrefixOrigin      : Dhcp
SuffixOrigin      : Dhcp
AddressState      : Preferred
ValidLifetime     : 00:53:23
PreferredLifetime : 00:53:23
SkipAsSource      : False
PolicyStore       : ActiveStore

IPAddress         : 127.0.0.1
InterfaceIndex    : 1
InterfaceAlias    : Loopback Pseudo-Interface 1
AddressFamily     : IPv4
Type              : Unicast
PrefixLength      : 8
PrefixOrigin      : WellKnown
SuffixOrigin      : WellKnown
AddressState      : Preferred
ValidLifetime     : Infinite ([TimeSpan]::MaxValue)
PreferredLifetime : Infinite ([TimeSpan]::MaxValue)
SkipAsSource      : False
PolicyStore       : ActiveStore
```
6. How many ports are listed as listening?

```
PS C:\Users\Administrator\Desktop> Get-NetTCPConnection | Format-List *

			X---Snip---X

State                    : Listen
AppliedSetting           :
OffloadState             : InHost
Caption                  :

			X---Snip---X
```

```
PS C:\Users\Administrator\Desktop> Get-NetTCPConnection | Where-Object -Property state -match listen | measure

Count    : 20
Average  :
Sum      :
Maximum  :
Minimum  :
Property :


PS C:\Users\Administrator\Desktop> Get-NetTCPConnection | Where-Object -Property state -eq listen | measure

Count    : 20
Average  :
Sum      :
Maximum  :
Minimum  :
Property :
```

7. What is the remote address of the local port listening on port 445?

```
PS C:\Users\Administrator\Desktop> Get-NetTCPConnection | Where-Object -Property LocalPort -eq 445

LocalAddress                        LocalPort RemoteAddress                       RemotePort State       AppliedSetting OwningProcess
------------                        --------- -------------                       ---------- -----       -------------- -------------
::                                  445       ::                                  0          Listen                     4
```
```
PS C:\Users\Administrator\Desktop> Get-NetTCPConnection | Where-Object -Property LocalPort -match 445

LocalAddress                        LocalPort RemoteAddress                       RemotePort State       AppliedSetting OwningProcess
------------                        --------- -------------                       ---------- -----       -------------- -------------
::                                  445       ::                                  0          Listen                     4
```

--> ::

8. How many patches have been applied?

```
PS C:\Users\Administrator\Desktop> Get-HotFix

Source        Description      HotFixID      InstalledBy          InstalledOn
------        -----------      --------      -----------          -----------
EC2AMAZ-5M... Update           KB3176936                          10/18/2016 12:00:00 AM
EC2AMAZ-5M... Update           KB3186568     NT AUTHORITY\SYSTEM  6/15/2017 12:00:00 AM
EC2AMAZ-5M... Update           KB3192137     NT AUTHORITY\SYSTEM  9/12/2016 12:00:00 AM
EC2AMAZ-5M... Update           KB3199209     NT AUTHORITY\SYSTEM  10/18/2016 12:00:00 AM
EC2AMAZ-5M... Update           KB3199986     EC2AMAZ-5M13VM2\A... 11/15/2016 12:00:00 AM
EC2AMAZ-5M... Update           KB4013418     EC2AMAZ-5M13VM2\A... 3/16/2017 12:00:00 AM
EC2AMAZ-5M... Update           KB4023834     EC2AMAZ-5M13VM2\A... 6/15/2017 12:00:00 AM
EC2AMAZ-5M... Update           KB4035631     NT AUTHORITY\SYSTEM  8/9/2017 12:00:00 AM
EC2AMAZ-5M... Update           KB4049065     NT AUTHORITY\SYSTEM  11/17/2017 12:00:00 AM
EC2AMAZ-5M... Update           KB4089510     NT AUTHORITY\SYSTEM  3/24/2018 12:00:00 AM
EC2AMAZ-5M... Update           KB4091664     NT AUTHORITY\SYSTEM  1/10/2019 12:00:00 AM
EC2AMAZ-5M... Update           KB4093137     NT AUTHORITY\SYSTEM  4/11/2018 12:00:00 AM
EC2AMAZ-5M... Update           KB4132216     NT AUTHORITY\SYSTEM  6/13/2018 12:00:00 AM
EC2AMAZ-5M... Security Update  KB4465659     NT AUTHORITY\SYSTEM  11/19/2018 12:00:00 AM
EC2AMAZ-5M... Security Update  KB4485447     NT AUTHORITY\SYSTEM  2/13/2019 12:00:00 AM
EC2AMAZ-5M... Security Update  KB4498947     NT AUTHORITY\SYSTEM  5/15/2019 12:00:00 AM
EC2AMAZ-5M... Security Update  KB4503537     NT AUTHORITY\SYSTEM  6/12/2019 12:00:00 AM
EC2AMAZ-5M... Security Update  KB4509091     NT AUTHORITY\SYSTEM  9/6/2019 12:00:00 AM
EC2AMAZ-5M... Security Update  KB4512574     NT AUTHORITY\SYSTEM  9/11/2019 12:00:00 AM
EC2AMAZ-5M... Security Update  KB4516044     NT AUTHORITY\SYSTEM  9/11/2019 12:00:00 AM
```

```
PS C:\Users\Administrator\Desktop> Get-HotFix | measure

Count    : 20
Average  :
Sum      :
Maximum  :
Minimum  :
Property :
```

--> 20


9. When was the patch with ID KB4023834 installed?

```
PS C:\Users\Administrator\Desktop> Get-HotFix | Where-Object -Property Hotfixid -eq KB4023834

Source        Description      HotFixID      InstalledBy          InstalledOn
------        -----------      --------      -----------          -----------
EC2AMAZ-5M... Update           KB4023834     EC2AMAZ-5M13VM2\A... 6/15/2017 12:00:00 AM

```
OR,
```
PS C:\Users\Administrator\Desktop> Get-HotFix | Where-Object -Property Hotfixid -match KB4023834

Source        Description      HotFixID      InstalledBy          InstalledOn
------        -----------      --------      -----------          -----------
EC2AMAZ-5M... Update           KB4023834     EC2AMAZ-5M13VM2\A... 6/15/2017 12:00:00 AM

```
OR,
```
Get-Hotfix -Id KB4023834
```

--> 6/15/2017 12:00:00 AM


10. Find the contents of a backup file.

```
PS C:\Users\Administrator\Desktop> Get-ChildItem -Path C:\ -Include *.bak* -File -Recurse -ErrorAction SilentlyContinue

    Directory: C:\Program Files (x86)\Internet Explorer

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        10/4/2019  12:42 AM             12 passwords.bak.txt


PS C:\Users\Administrator\Desktop> Get-Content "C:\Program Files (x86)\Internet Explorer\passwords.bak.txt"
backpassflag
```

--> backpassflag


11. Search for all files containing `API_KEY`

```
PS C:\Users\Administrator> Get-ChildItem C:\* -Recurse | Select-String -pattern API_KEY
```
OR,
```
PS C:\Users\Administrator> Get-ChildItem C:\ -Recurse | Select-String -pattern API_KEY
```

![](https://github.com/reveng007/TryHackMe/blob/main/_SUBSCRIPTION_/paths/Complete%20Beginner/06.Windows%20Exploitation%20Basics/05.Hacking%20with%20Powershell/pic1.png?raw=true)


--> fakekey123


12. What command do you do to list all the running processes?

--> Get-Process

13. What is the path of the scheduled task called new-sched-task?

```
PS C:\Users\Administrator> Get-ScheduledTask | Where-Object -Property Taskname -match new-sched-task

TaskPath                                       TaskName                          State
--------                                       --------                          -----
\                                              new-sched-task                    Ready


PS C:\Users\Administrator> Get-ScheduledTask | Where-Object -Property Taskname -eq new-sched-task

TaskPath                                       TaskName                          State
--------                                       --------                          -----
\                                              new-sched-task                    Ready


PS C:\Users\Administrator> Get-ScheduledTask | Where-Object Taskname -eq new-sched-task

TaskPath                                       TaskName                          State
--------                                       --------                          -----
\                                              new-sched-task                    Ready


PS C:\Users\Administrator> Get-ScheduledTask | Where-Object Taskname -match new-sched-task

TaskPath                                       TaskName                          State
--------                                       --------                          -----
\                                              new-sched-task                    Ready

```
--> /


14. Who is the owner of the C:\

```
PS C:\Users\Administrator> Get-Acl c:/

    Directory:

Path Owner                       Access
---- -----                       ------
C:\  NT SERVICE\TrustedInstaller CREATOR OWNER Allow  268435456...

```

--> NT SERVICE\TrustedInstaller


Task5:  Basic Scripting Challenge
----------------------------------

Now that we have run powershell commands, let's actually try write and run a script to do more complex and powerful actions. 

For this ask, we'll be using PowerShell ISE(which is the Powershell Text Editor).

To show an example of this script, let's use a particular scenario.
Given a list of port numbers, we want to use this list to see if the local port is listening. 

- Open the listening-ports.ps1 script on the Desktop using Powershell ISE.

- Powershell scripts usually have the .ps1 file extension. 

This is the `powershell_script`:
```
$system_ports = Get-NetTCPConnection -State Listen

$text_port = Get-Content -Path C:\Users\Administrator\Desktop\ports.txt

foreach($port in $text_port){

    if($port -in $system_ports.LocalPort){

        echo $port

     }

}
```
<ins>1st line:</ins>
On the first line, we want to get a list of all the ports on the system that are listening. We do this using the _Get-NetTCPConnection_ cmdlet.

<ins>2nd line</ins>
On the next line, we want to read a list of ports from the file. We do this using the _Get-Content_ cmdlet. Again, we store this output in the variables.

<ins>3rd line</ins>
Next step is to iterate through all the ports in the file to see if the ports are listening. To iterate through the ports in the file, we use the following:

`foreach($new_var in $existing_var){}`

This particular code block is used to loop(for loop) through a set of object. Once we have each individual port, we want to check if this port occurs in the listening local ports. Instead of doing another for loop, we just use an if statement with the `-in` operator to check if the port exists the LocalPort property of any object. A full list of if statement comparison operators can be found [here](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_comparison_operators?view=powershell-6).


To run script, just `call the script path using Powershell` or click the `green button on Powershell ISE`


***TASK***
Now that we've seen what a basic script looks like - it's time to write one of your own.

The emails folder on the Desktop contains copies of the emails John, Martha and Mary have been sending to each other(and themselves).

It is a good resource to use: [learnXinYminutes](https://learnxinyminutes.com/docs/powershell/)

1. What file contains the password?

```
PS C:\Users\Administrator\Desktop\emails> $path = "C:\Users\Administrator\Desktop\emails"
PS C:\Users\Administrator\Desktop\emails> echo $path
C:\Users\Administrator\Desktop\emails

PS C:\Users\Administrator\Desktop\emails> $string_pattern = "password"
PS C:\Users\Administrator\Desktop\emails> $command = Get-ChildItem -Path $path -Recurse | Select-String -Pattern $String_pattern
PS C:\Users\Administrator\Desktop\emails> echo $command

john\Doc3.txt:6:I got some errors trying to access my passwords file - is there any way you can help? Here is the output I got
martha\Doc3M.txt:6:I managed to fix the corrupted file to get the output, but the password is buried somewhere in these logs:
martha\Doc3M.txt:106:password is johnisalegend99

```

--> Doc3M

2. What is the password?

--> johnisalegend99

3. What files contains an HTTPS link?

```
PS C:\Users\Administrator\Desktop\emails> $path = "C:\Users\Administrator\Desktop\emails"

PS C:\Users\Administrator\Desktop\emails> echo $path
C:\Users\Administrator\Desktop\emails

PS C:\Users\Administrator\Desktop\emails> $string_pattern = "https"

PS C:\Users\Administrator\Desktop\emails> $command = Get-ChildItem -Path $path -Recurse | Select-String -Pattern $String_pattern

PS C:\Users\Administrator\Desktop\emails> echo $command

mary\Doc2Mary.txt:5:https://www.howtoworkwell.rand/

```

--> Doc2Mary


Task6:  Intermediate Scripting
-------------------------------

<ins>Build a TCp Connect scanner</ins>:
1. Determine IP ranges to scan(in this case it will be localhost) and you can provide the input in any way you want
2. Determine the port ranges to scan
3. Determine the type of scan to run(in this case it will be a simple TCP Connect Scan)


1. Task 6  Intermediate Scripting

[Hint: either use raw TCP sockets or Test-NetConnection]

```
for($i=130; $i -le 140; $i++){
    Test-NetConnection localhost -Port $i
}
```

I didn't get any thing better script...

And also I feeling Lazy to research on it...

--> 11


see: [specterops](https://github.com/specterops/at-ps)


